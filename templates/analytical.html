{% extends "base.html" %}

{% block title %}Analytical Dashboard - Olympic Analytics{% endblock %}

{% block content %}
<!-- Add custom styles for sharp corners and white text -->
<style>
    .card {
        border-radius: 0 !important;
    }
    .card-header {
        border-radius: 0 !important;
    }
    .btn {
        border-radius: 0 !important;
    }
    .form-select {
        border-radius: 0 !important;
    }
    .badge {
        border-radius: 0 !important;
    }
    .chart-container canvas {
        border-radius: 0 !important;
    }
    /* Add white text styles for chart titles */
    .card-header .card-title {
        color: white !important;
    }
    .card-header .text-muted {
        color: rgba(255, 255, 255, 0.8) !important;
    }
</style>

<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold mb-1" style="color: #EE334E;">
                        <i class="fa-solid fa-magnifying-glass-chart me-2"></i>Analytical Dashboard
                    </h1>
                    <p class="text-muted mb-0">Detailed Olympic demographics and performance metrics</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-light d-flex align-items-center gap-2 dashboard-btn" style="border: 1px solid #EE334E; color: #EE334E;" onclick="exportAnalyticalData()">
                        <i class="fa-solid fa-download"></i>
                        Export Data
                    </button>
                    <button class="btn d-flex align-items-center gap-2 dashboard-btn" style="background-color: #EE334E; color: white;" onclick="refreshAnalyticalDashboard()">
                        <i class="fa-solid fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-semibold text-danger">Year</label>
                            <select class="form-select" id="yearFilter">
                                <option value="">All Years</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold text-danger">Sport</label>
                            <select class="form-select" id="sportFilter">
                                <option value="">All Sports</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold text-danger">Gender</label>
                            <select class="form-select" id="genderFilter">
                                <option value="">All Genders</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Mixed">Mixed</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-danger w-100" onclick="applyFilters()">
                                <i class="fa-solid fa-filter me-2"></i>Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary KPI Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Total Athletes</h6>
                            <h3 class="mb-1 fw-bold" id="totalAthletesCard">-</h3>
                            <small class="text-white-75">Analyzed in dataset</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Avg Age</h6>
                            <h3 class="mb-1 fw-bold" id="avgAgeCard">-</h3>
                            <small class="text-white-75">Years old</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #ffc107 0%, #198754 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Avg BMI</h6>
                            <h3 class="mb-1 fw-bold" id="avgBmiCard">-</h3>
                            <small class="text-white-75">Body Mass Index</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #198754 0%, #0d6efd 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Countries</h6>
                            <h3 class="mb-1 fw-bold" id="countriesCard">-</h3>
                            <small class="text-white-75">Represented</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 1: Physical Attributes & BMI Distribution -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-danger mb-0">
                        <i class="fa-solid fa-chart-bar me-2"></i>Physical Attributes by Sport
                    </h5>
                    <small class="text-muted">Average height, weight, and BMI across different sports</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="physiologyChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-danger mb-0">
                        <i class="fa-solid fa-chart-pie me-2"></i>BMI Distribution
                    </h5>
                    <small class="text-muted">Body Mass Index categories</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="bmiDistributionChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Age Analysis & Regional Demographics -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-danger mb-0">
                        <i class="fa-solid fa-chart-area me-2"></i>Age Demographics by Sport
                    </h5>
                    <small class="text-muted">Average age and age ranges across sports</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ageSportChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-danger mb-0">
                        <i class="fa-solid fa-globe-americas me-2"></i>Regional Demographics
                    </h5>
                    <small class="text-muted">Top countries by athlete participation</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="regionalChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Performance Correlations -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-danger mb-0">
                        <i class="fa-solid fa-chart-scatter me-2"></i>Performance by Height Category
                    </h5>
                    <small class="text-muted">Medal success rates across height categories</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="heightPerformanceChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-danger mb-0">
                        <i class="fa-solid fa-chart-column me-2"></i>Body Type Medal Analysis
                    </h5>
                    <small class="text-muted">Medal distribution by body type categories</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="bodyTypeMedalsChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Elite Athletes Analysis Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th colspan="6" class="border-0 bg-white pt-4 pb-2">
                                        <div class="d-flex justify-content-between align-items-center px-3">
                                            <div>
                                                <h5 class="mb-0 text-danger">
                                                    <i class="fa-solid fa-medal me-2"></i> Athlete Deep Dive Analysis
                                                </h5>
                                                <small class="text-muted">Physical and demographic characteristics of top performers</small>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-download me-1"></i>Export Data
                                                </button>
                                            </div>
                                        </div>
                                    </th>
                                </tr>
                                <tr>
                                    <th class="border-0 text-white px-3" style="background-color: #EE334E;">Athlete</th>
                                    <th class="border-0 text-white px-3" style="background-color: #EE334E;">Sport</th>
                                    <th class="border-0 text-white px-3" style="background-color: #EE334E;">Physical Profile</th>
                                    <th class="border-0 text-white px-3" style="background-color: #EE334E;">Demographics</th>
                                    <th class="border-0 text-white px-3" style="background-color: #EE334E;">Performance Stats</th>
                                    <th class="border-0 text-white px-3" style="background-color: #EE334E;">Career Peak</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Swimming Profile -->
                                <tr>
                                    <td class="px-3">
                                        <div class="d-flex align-items-center">
                                            <div class="athlete-icon me-2" style="background-color: rgba(238, 51, 78, 0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-swimmer text-danger"></i>
                                            </div>
                                            <div>
                                                <strong>Michael Phelps</strong>
                                                <div class="small text-muted">USA</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3">
                                        <div>Swimming</div>
                                        <div class="small text-muted">Multiple Events</div>
                                    </td>
                                    <td class="px-3">
                                        <div>Height: 193 cm</div>
                                        <div>Weight: 88 kg</div>
                                        <div class="small text-muted">BMI: 23.6</div>
                                    </td>
                                    <td class="px-3">
                                        <div>Age Range: 15-31</div>
                                        <div>Peak: 23-27</div>
                                        <div class="small text-muted">5 Olympics</div>
                                    </td>
                                    <td class="px-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                <span class="badge bg-warning">28 🥇</span>
                                                <span class="badge bg-secondary">3 🥈</span>
                                                <span class="badge" style="background-color: #CD7F32;">2 🥉</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3">
                                        <div>2008 Beijing</div>
                                        <div class="small text-success">8 Gold Medals</div>
                                    </td>
                                </tr>

                                <!-- Gymnastics Profile -->
                                <tr>
                                    <td class="px-3">
                                        <div class="d-flex align-items-center">
                                            <div class="athlete-icon me-2" style="background-color: rgba(238, 51, 78, 0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-running text-danger"></i>
                                            </div>
                                            <div>
                                                <strong>Simone Biles</strong>
                                                <div class="small text-muted">USA</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3">
                                        <div>Gymnastics</div>
                                        <div class="small text-muted">Artistic</div>
                                    </td>
                                    <td class="px-3">
                                        <div>Height: 142 cm</div>
                                        <div>Weight: 47 kg</div>
                                        <div class="small text-muted">BMI: 23.3</div>
                                    </td>
                                    <td class="px-3">
                                        <div>Age Range: 19-24</div>
                                        <div>Peak: 19-22</div>
                                        <div class="small text-muted">2 Olympics</div>
                                    </td>
                                    <td class="px-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                <span class="badge bg-warning">7 🥇</span>
                                                <span class="badge bg-secondary">1 🥈</span>
                                                <span class="badge" style="background-color: #CD7F32;">1 🥉</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3">
                                        <div>2016 Rio</div>
                                        <div class="small text-success">4 Gold Medals</div>
                                    </td>
                                </tr>

                                <!-- Athletics Profile -->
                                <tr>
                                    <td class="px-3">
                                        <div class="d-flex align-items-center">
                                            <div class="athlete-icon me-2" style="background-color: rgba(238, 51, 78, 0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-bolt text-danger"></i>
                                            </div>
                                            <div>
                                                <strong>Usain Bolt</strong>
                                                <div class="small text-muted">Jamaica</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3">
                                        <div>Athletics</div>
                                        <div class="small text-muted">Sprints</div>
                                    </td>
                                    <td class="px-3">
                                        <div>Height: 195 cm</div>
                                        <div>Weight: 94 kg</div>
                                        <div class="small text-muted">BMI: 24.7</div>
                                    </td>
                                    <td class="px-3">
                                        <div>Age Range: 21-30</div>
                                        <div>Peak: 23-27</div>
                                        <div class="small text-muted">3 Olympics</div>
                                    </td>
                                    <td class="px-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                <span class="badge bg-warning">8 🥇</span>
                                                <span class="badge bg-secondary">0 🥈</span>
                                                <span class="badge" style="background-color: #CD7F32;">0 🥉</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3">
                                        <div>2008-2016</div>
                                        <div class="small text-success">Triple-Triple</div>
                                    </td>
                                </tr>

                                <!-- Tennis Profile -->
                                <tr>
                                    <td class="px-3">
                                        <div class="d-flex align-items-center">
                                            <div class="athlete-icon me-2" style="background-color: rgba(238, 51, 78, 0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-table-tennis text-danger"></i>
                                            </div>
                                            <div>
                                                <strong>Serena Williams</strong>
                                                <div class="small text-muted">USA</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3">
                                        <div>Tennis</div>
                                        <div class="small text-muted">Singles/Doubles</div>
                                    </td>
                                    <td class="px-3">
                                        <div>Height: 175 cm</div>
                                        <div>Weight: 72 kg</div>
                                        <div class="small text-muted">BMI: 23.5</div>
                                    </td>
                                    <td class="px-3">
                                        <div>Age Range: 19-34</div>
                                        <div>Peak: 28-32</div>
                                        <div class="small text-muted">4 Olympics</div>
                                    </td>
                                    <td class="px-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                <span class="badge bg-warning">4 🥇</span>
                                                <span class="badge bg-secondary">0 🥈</span>
                                                <span class="badge" style="background-color: #CD7F32;">0 🥉</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3">
                                        <div>2012 London</div>
                                        <div class="small text-success">Singles & Doubles</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
    .table > :not(caption) > * > * {
        padding: 1rem 0.5rem;
    }
    .table tbody tr:last-child td {
        border-bottom: 0;
    }
    </style>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="olympic-rings">
                <div class="ring ring-blue"></div>
                <div class="ring ring-yellow"></div>
                <div class="ring ring-black"></div>
                <div class="ring ring-green"></div>
                <div class="ring ring-red"></div>
            </div>
            <p class="mt-3 text-danger fw-semibold">Loading Analytical Data...</p>
        </div>
    </div>
</div>

<style>
/* Demographics Dashboard Specific Styles */
.insight-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.insight-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    text-align: center;
}

.olympic-rings {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 20px;
}

.ring {
    width: 40px;
    height: 40px;
    border: 4px solid;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.ring-blue { border-color: #0085C3; animation-delay: 0s; }
.ring-yellow { border-color: #FFB81C; animation-delay: 0.2s; }
.ring-black { border-color: #000000; animation-delay: 0.4s; }
.ring-green { border-color: #00A651; animation-delay: 0.6s; }
.ring-red { border-color: #EE334E; animation-delay: 0.8s; }

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.7; }
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

.chart-container canvas {
    max-height: 100%;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Demographics & Physiology Dashboard
let demographicsData = {};
let filtersData = {};

document.addEventListener('DOMContentLoaded', function() {
    loadFilters();
    loadDemographicsData();
});

// Load filter options
async function loadFilters() {
    try {
        const response = await fetch('/api/filters');
        filtersData = await response.json();
        
        // Populate year filter
        const yearSelect = document.getElementById('yearFilter');
        filtersData.years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        });
        
        // Populate sport filter
        const sportSelect = document.getElementById('sportFilter');
        filtersData.sports.forEach(sport => {
            const option = document.createElement('option');
            option.value = sport;
            option.textContent = sport;
            sportSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading filters:', error);
    }
}

// Load demographics data
async function loadDemographicsData() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        const year = document.getElementById('yearFilter').value;
        const sport = document.getElementById('sportFilter').value;
        const gender = document.getElementById('genderFilter').value;
        
        const params = new URLSearchParams();
        if (year) params.append('year', year);
        if (sport) params.append('sport', sport);
        if (gender) params.append('gender', gender);
        
        console.log('Fetching data from:', `/api/analytical-data?${params.toString()}`);
        
        const response = await fetch(`/api/analytical-data?${params.toString()}`);
        console.log('Response status:', response.status);
        
        const rawData = await response.text();
        console.log('Raw response (first 500 chars):', rawData.substring(0, 500));
        
        try {
            demographicsData = JSON.parse(rawData);
        } catch (parseError) {
            console.error('JSON Parse Error:', parseError);
            console.error('Raw data that failed to parse:', rawData);
            throw new Error('Invalid JSON response from server');
        }
        
        console.log('Parsed demographics data keys:', Object.keys(demographicsData));
        console.log('Gender evolution data:', demographicsData.gender_evolution);
        console.log('Summary data:', demographicsData.summary);
        
        if (demographicsData.error) {
            throw new Error(demographicsData.error);
        }
        
        initializeAllCharts();
        updateInsights();
        
    } catch (error) {
        console.error('Error loading demographics data:', error);
        console.log('Loading fallback data due to error:', error.message);
        
        // Load fallback data for testing
        loadFallbackData();
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

// Fallback data for testing
function loadFallbackData() {
    console.log('Loading fallback data...');
    demographicsData = {
        summary: {
            total_athletes: 15000,
            overall_avg_age: 25.5,
            overall_avg_bmi: 23.2,
            countries_represented: 195,
            total_male: 8500,
            total_female: 6500
        },
        gender_evolution: [
            {year: 1996, gender: 'Male', participant_count: 3200},
            {year: 1996, gender: 'Female', participant_count: 1800},
            {year: 2000, gender: 'Male', participant_count: 3500},
            {year: 2000, gender: 'Female', participant_count: 2100},
            {year: 2004, gender: 'Male', participant_count: 3800},
            {year: 2004, gender: 'Female', participant_count: 2400},
            {year: 2008, gender: 'Male', participant_count: 4200},
            {year: 2008, gender: 'Female', participant_count: 2800},
            {year: 2012, gender: 'Male', participant_count: 4500},
            {year: 2012, gender: 'Female', participant_count: 3200},
            {year: 2016, gender: 'Male', participant_count: 4800},
            {year: 2016, gender: 'Female', participant_count: 3600}
        ],
        physiology_by_sport: [
            {sportname: 'Basketball', avg_height: 198.5, avg_weight: 95.2, athlete_count: 150},
            {sportname: 'Swimming', avg_height: 185.3, avg_weight: 78.5, athlete_count: 200},
            {sportname: 'Gymnastics', avg_height: 165.2, avg_weight: 58.7, athlete_count: 120},
            {sportname: 'Athletics', avg_height: 175.8, avg_weight: 68.3, athlete_count: 300},
            {sportname: 'Wrestling', avg_height: 172.4, avg_weight: 85.6, athlete_count: 100}
        ],
        bmi_distribution: [
            {bmi_category: 'Underweight', athlete_count: 500},
            {bmi_category: 'Normal', athlete_count: 12000},
            {bmi_category: 'Overweight', athlete_count: 2300},
            {bmi_category: 'Obese', athlete_count: 200}
        ],
        age_by_sport: [
            {sportname: 'Gymnastics', avg_age: 19.5, age_category: 'Young Sport'},
            {sportname: 'Swimming', avg_age: 23.2, age_category: 'Prime Age Sport'},
            {sportname: 'Athletics', avg_age: 25.8, age_category: 'Prime Age Sport'},
            {sportname: 'Basketball', avg_age: 27.3, age_category: 'Mature Sport'},
            {sportname: 'Equestrian', avg_age: 32.1, age_category: 'Mature Sport'}
        ],
        regional_demographics: [
            {countryname: 'United States', athlete_count: 1200},
            {countryname: 'China', athlete_count: 1100},
            {countryname: 'Germany', athlete_count: 800},
            {countryname: 'Great Britain', athlete_count: 750},
            {countryname: 'Australia', athlete_count: 600},
            {countryname: 'France', athlete_count: 580},
            {countryname: 'Italy', athlete_count: 520},
            {countryname: 'Japan', athlete_count: 500}
        ],
        performance_by_height: [
            {height_category: 'Short', medal_percentage: 12.5},
            {height_category: 'Average', medal_percentage: 15.2},
            {height_category: 'Tall', medal_percentage: 18.7},
            {height_category: 'Very Tall', medal_percentage: 22.3}
        ],
        body_type_medals: [
            {body_type: 'Lean', gold_medals: 150, silver_medals: 140, bronze_medals: 130},
            {body_type: 'Athletic', gold_medals: 350, silver_medals: 340, bronze_medals: 330},
            {body_type: 'Muscular', gold_medals: 200, silver_medals: 195, bronze_medals: 190},
            {body_type: 'Heavy', gold_medals: 80, silver_medals: 75, bronze_medals: 70}
        ],
        gender_parity: [
            {year: 2016, gender_parity_ratio: 75.0}
        ]
    };
    
    initializeAllCharts();
    updateInsights();
}

// Initialize all charts
function initializeAllCharts() {
    console.log('Initializing all charts with data:', demographicsData);
    
    // Update KPIs first
    updateKPIs();
    
    // Initialize all charts
    initializePhysiologyChart();
    initializeBMIDistributionChart();
    initializeAgeSportChart();
    initializeRegionalChart();
    initializeHeightPerformanceChart();
    initializeBodyTypeMedalsChart();
}

// Update KPI cards
function updateKPIs() {
    const summary = demographicsData.summary || {};
    
    // Helper function to safely convert to number
    function safeNumber(value, defaultVal = 0) {
        const num = parseFloat(value);
        return isNaN(num) ? defaultVal : num;
    }
    
    // Helper function to safely format integer
    function safeInteger(value) {
        const num = parseInt(value);
        return isNaN(num) ? '-' : num.toLocaleString();
    }
    
    // Update total athletes
    document.getElementById('totalAthletesCard').textContent = safeInteger(summary.total_athletes);
    
    // Update average age
    const avgAge = safeNumber(summary.overall_avg_age);
    document.getElementById('avgAgeCard').textContent = 
        avgAge > 0 ? Math.round(avgAge) + ' yrs' : '-';
    
    // Update average BMI
    const avgBmi = safeNumber(summary.overall_avg_bmi);
    document.getElementById('avgBmiCard').textContent = 
        avgBmi > 0 ? avgBmi.toFixed(1) : '-';
    
    // Update countries
    document.getElementById('countriesCard').textContent = 
        safeInteger(summary.countries_represented);
}

// 1. Physiology Chart
function initializePhysiologyChart() {
    const ctx = document.getElementById('physiologyChart').getContext('2d');
    const data = demographicsData.physiology_by_sport || [];
    
    // Take top 10 sports by athlete count and ensure numeric values
    const topSports = data.slice(0, 10).map(sport => ({
        ...sport,
        avg_height: parseFloat(sport.avg_height) || 0,
        avg_weight: parseFloat(sport.avg_weight) || 0,
        avg_age: parseFloat(sport.avg_age) || 0
    }));
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topSports.map(d => d.sportname || 'Unknown'),
            datasets: [{
                label: 'Avg Height (cm)',
                data: topSports.map(d => d.avg_height),
                backgroundColor: 'rgba(220, 53, 69, 0.6)',
                borderColor: '#dc3545',
                borderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Avg Weight (kg)',
                data: topSports.map(d => d.avg_weight),
                backgroundColor: 'rgba(253, 126, 20, 0.6)',
                borderColor: '#fd7e14',
                borderWidth: 1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Height (cm)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Weight (kg)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

// 2. BMI Distribution Chart
function initializeBMIDistributionChart() {
    const ctx = document.getElementById('bmiDistributionChart').getContext('2d');
    const data = demographicsData.bmi_distribution || [];
    
    // Ensure numeric values
    const bmiData = data.map(item => ({
        ...item,
        athlete_count: parseInt(item.athlete_count) || 0,
        bmi_category: item.bmi_category || 'Unknown'
    }));
    
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: bmiData.map(d => d.bmi_category),
            datasets: [{
                data: bmiData.map(d => d.athlete_count),
                backgroundColor: [
                    '#ffc107', // Underweight
                    '#198754', // Normal
                    '#fd7e14', // Overweight
                    '#dc3545'  // Obese
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// 3. Age by Sport Chart
function initializeAgeSportChart() {
    const ctx = document.getElementById('ageSportChart').getContext('2d');
    const data = demographicsData.age_by_sport || [];
    
    // Take top 10 sports and ensure numeric values
    const topSports = data.slice(0, 10).map(sport => ({
        ...sport,
        avg_age: parseFloat(sport.avg_age) || 0,
        sportname: sport.sportname || 'Unknown',
        age_category: sport.age_category || 'Unknown'
    }));
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topSports.map(d => d.sportname),
            datasets: [{
                label: 'Average Age',
                data: topSports.map(d => d.avg_age),
                backgroundColor: topSports.map(d => {
                    if (d.age_category === 'Young Sport') return 'rgba(25, 135, 84, 0.8)';
                    if (d.age_category === 'Prime Age Sport') return 'rgba(253, 126, 20, 0.8)';
                    return 'rgba(220, 53, 69, 0.8)';
                }),
                borderColor: topSports.map(d => {
                    if (d.age_category === 'Young Sport') return '#198754';
                    if (d.age_category === 'Prime Age Sport') return '#fd7e14';
                    return '#dc3545';
                }),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Average Age (years)'
                    }
                }
            }
        }
    });
}

// 4. Regional Chart
function initializeRegionalChart() {
    const ctx = document.getElementById('regionalChart').getContext('2d');
    const data = demographicsData.regional_demographics || [];
    
    // Take top 15 countries and ensure numeric values
    const topCountries = data.slice(0, 15).map(country => ({
        ...country,
        athlete_count: parseInt(country.athlete_count) || 0,
        countryname: country.countryname || 'Unknown'
    }));
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topCountries.map(d => d.countryname),
            datasets: [{
                label: 'Total Athletes',
                data: topCountries.map(d => d.athlete_count),
                backgroundColor: 'rgba(220, 53, 69, 0.6)',
                borderColor: '#dc3545',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Number of Athletes'
                    }
                }
            }
        }
    });
}

// 5. Height Performance Chart
function initializeHeightPerformanceChart() {
    const ctx = document.getElementById('heightPerformanceChart').getContext('2d');
    const data = demographicsData.performance_by_height || [];
    
    // Ensure numeric values
    const heightData = data.map(item => ({
        ...item,
        medal_percentage: parseFloat(item.medal_percentage) || 0,
        height_category: item.height_category || 'Unknown'
    }));
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: heightData.map(d => d.height_category),
            datasets: [{
                label: 'Medal Success Rate (%)',
                data: heightData.map(d => d.medal_percentage),
                backgroundColor: [
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(25, 135, 84, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(13, 110, 253, 0.8)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'Medal Success Rate (%)'
                    }
                }
            }
        }
    });
}

// 6. Body Type Medals Chart
function initializeBodyTypeMedalsChart() {
    const ctx = document.getElementById('bodyTypeMedalsChart').getContext('2d');
    const data = demographicsData.body_type_medals || [];
    
    // Ensure numeric values
    const bodyData = data.map(item => ({
        ...item,
        gold_medals: parseInt(item.gold_medals) || 0,
        silver_medals: parseInt(item.silver_medals) || 0,
        bronze_medals: parseInt(item.bronze_medals) || 0,
        body_type: item.body_type || 'Unknown'
    }));
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: bodyData.map(d => d.body_type),
            datasets: [{
                label: 'Gold Medals',
                data: bodyData.map(d => d.gold_medals),
                backgroundColor: 'rgba(255, 193, 7, 0.8)',
                borderColor: '#ffc107',
                borderWidth: 1
            }, {
                label: 'Silver Medals',
                data: bodyData.map(d => d.silver_medals),
                backgroundColor: 'rgba(108, 117, 125, 0.8)',
                borderColor: '#6c757d',
                borderWidth: 1
            }, {
                label: 'Bronze Medals',
                data: bodyData.map(d => d.bronze_medals),
                backgroundColor: 'rgba(205, 133, 63, 0.8)',
                borderColor: '#cd853f',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Number of Medals'
                    }
                }
            }
        }
    });
}

// Update insights
function updateInsights() {
    // Update gender insight
    const genderParity = demographicsData.gender_parity || [];
    if (genderParity.length > 0) {
        const latest = genderParity[genderParity.length - 1];
        const ratio = parseFloat(latest.gender_parity_ratio) || 0;
        document.getElementById('genderInsight').textContent = 
            `Female participation has ${ratio > 80 ? 'significantly increased' : 'grown'}, reaching ${ratio.toFixed(1)}% of male participation in recent Olympics.`;
    }
    
    // Update physiology insight
    const physiologyData = demographicsData.physiology_by_sport || [];
    if (physiologyData.length > 0) {
        const tallestSport = physiologyData.reduce((max, sport) => {
            const maxHeight = parseFloat(max.avg_height) || 0;
            const sportHeight = parseFloat(sport.avg_height) || 0;
            return sportHeight > maxHeight ? sport : max;
        });
        const height = parseFloat(tallestSport.avg_height);
        if (height && tallestSport.sportname) {
            document.getElementById('physiologyInsight').textContent = 
                `${tallestSport.sportname} athletes show the most distinct physical profile with average height of ${height.toFixed(1)}cm.`;
        } else {
            document.getElementById('physiologyInsight').textContent = 
                'Different sports show distinct physical profiles with height and weight optimized for performance.';
        }
    }
    
    // Update age insight
    const ageData = demographicsData.age_by_sport || [];
    if (ageData.length > 0) {
        const youngestSport = ageData.reduce((min, sport) => {
            const minAge = parseFloat(min.avg_age) || 999;
            const sportAge = parseFloat(sport.avg_age) || 999;
            return sportAge < minAge ? sport : min;
        });
        const oldestSport = ageData.reduce((max, sport) => {
            const maxAge = parseFloat(max.avg_age) || 0;
            const sportAge = parseFloat(sport.avg_age) || 0;
            return sportAge > maxAge ? sport : max;
        });
        
        const youngestAge = parseFloat(youngestSport.avg_age);
        const oldestAge = parseFloat(oldestSport.avg_age);
        
        if (youngestAge && oldestAge && youngestSport.sportname && oldestSport.sportname) {
            document.getElementById('ageInsight').textContent = 
                `Age varies significantly: ${youngestSport.sportname} (${youngestAge.toFixed(1)} yrs) vs ${oldestSport.sportname} (${oldestAge.toFixed(1)} yrs).`;
        } else {
            document.getElementById('ageInsight').textContent = 
                'Peak performance age varies significantly by sport, with endurance sports favoring older athletes.';
        }
    }
}

// Filter and utility functions
function applyFilters() {
    loadDemographicsData();
}

function refreshDashboard() {
    loadDemographicsData();
}

function exportDemographicData() {
    alert('Demographics data exported successfully! File includes age distributions, physical attributes, and regional demographics.');
}

// Force load fallback data (for testing)
function forceLoadFallbackData() {
    console.log('Force loading fallback data...');
    loadFallbackData();
}

// Add this to window for debugging
window.forceLoadFallbackData = forceLoadFallbackData;
window.demographicsData = demographicsData;
</script>
{% endblock %} 