{% extends "base.html" %}

{% block title %}Operational Dashboard - Olympic Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold mb-1" style="color: #FFB81C;">
                        <i class="fa-solid fa-cogs me-2"></i>Operational Dashboard
                    </h1>
                    <p class="text-muted mb-0">Real-time Olympic operations monitoring and control</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-light d-flex align-items-center gap-2 dashboard-btn" style="border: 1px solid #FFB81C; color: #FFB81C;" onclick="exportOperationalData()">
                        <i class="fa-solid fa-download"></i>
                        Export Data
                    </button>
                    <button class="btn d-flex align-items-center gap-2 dashboard-btn" style="background-color: #FFB81C; color: white;" onclick="refreshOperationalDashboard()">
                        <i class="fa-solid fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-Time Status Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #0085C3 0%, #00A651 100%);">
                <div class="card-body py-3">
                    <div class="row text-white text-center">
                        <div class="col-md-2">
                            <div class="d-flex align-items-center justify-content-center">
                                <i class="fas fa-circle text-success me-2" id="systemStatus"></i>
                                <div>
                                    <div class="fw-bold">System Status</div>
                                    <small id="systemStatusText">All Systems Operational</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold fs-4" id="currentTime">--:--:--</div>
                            <small>Local Time</small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold fs-4" id="activeEvents">12</div>
                            <small>Active Events</small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold fs-4" id="totalAttendees">89,432</div>
                            <small>Total Attendees</small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold fs-4" id="activeStaff">2,847</div>
                            <small>Active Staff</small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold fs-4" id="weatherTemp">24Â°C</div>
                            <small>Weather</small>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>

    <!-- Critical Alerts & KPIs Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #00A651 0%, #34D37F 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Venue Capacity</h6>
                            <h3 class="mb-1 fw-bold" id="venueCapacityPercent">87%</h3>
                            <small class="text-white-75">Average utilization</small>
                            <div class="mt-2">
                                <div class="progress" style="height: 6px; background: rgba(255,255,255,0.3);">
                                    <div class="progress-bar bg-white" style="width: 87%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #FFB81C 0%, #FFC947 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Transportation</h6>
                            <h3 class="mb-1 fw-bold" id="transportOnTime">94%</h3>
                            <small class="text-white-75">On-time performance</small>
                            <div class="mt-2">
                                <div class="progress" style="height: 6px; background: rgba(255,255,255,0.3);">
                                    <div class="progress-bar bg-white" style="width: 94%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #EE334E 0%, #FF6B84 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Security Status</h6>
                            <h3 class="mb-1 fw-bold" id="securityLevel">High</h3>
                            <small class="text-white-75">Current alert level</small>
                            <div class="mt-2">
                                <div class="d-flex justify-content-between">
                                    <small class="text-white-75">System Status:</small>
                                    <small class="text-white">Operational</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #0085C3 0%, #2BB1E4 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Active Incidents</h6>
                            <h3 class="mb-1 fw-bold" id="activeIncidents">2</h3>
                            <small class="text-white-75">Requiring attention</small>
                            <div class="mt-2">
                                <div class="d-flex justify-content-between">
                                    <small class="text-white-75">Response Time:</small>
                                    <small class="text-white">< 5 mins</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Operations Row 1: Venue & Event Management -->
    <div class="row mb-4">
        <!-- Venue Status Overview -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        <i class="fa-solid fa-building me-2"></i>Venue Operations Status
                    </h5>
                    <small class="text-subtitle">Real-time capacity and operational status across all Olympic venues</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="venueStatusChart" width="400" height="300"></canvas>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4 text-center">
                            <div class="badge bg-success fs-6 px-3 py-2">
                                <i class="fas fa-check-circle me-2"></i>
                                <span id="operationalVenues">15</span> Operational
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="badge bg-warning fs-6 px-3 py-2">
                                <i class="fas fa-tools me-2"></i>
                                <span id="maintenanceVenues">2</span> Maintenance
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="badge bg-info fs-6 px-3 py-2">
                                <i class="fas fa-clock me-2"></i>
                                <span id="preparingVenues">1</span> Preparing
                            </div>
            </div>
        </div>
    </div>
            </div>
        </div>

        <!-- Critical Alerts Panel -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        <i class="fa-solid fa-bell me-2"></i>Priority Alerts
                    </h5>
                    <small class="text-subtitle">Immediate attention required</small>
                </div>
                <div class="card-body">
                    <div id="alertsList" class="alerts-container">
                        <div class="alert-item mb-3 p-3 rounded" style="background: rgba(255, 184, 28, 0.1); border-left: 4px solid #FFB81C;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold text-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Aquatics Center
                                    </div>
                                    <small class="text-muted">Pool temperature adjustment needed</small>
                                    <div class="mt-1">
                                        <span class="badge bg-warning text-dark">Medium Priority</span>
                                        <small class="text-muted ms-2">5 min ago</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert-item mb-3 p-3 rounded" style="background: rgba(0, 166, 81, 0.1); border-left: 4px solid #00A651;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold text-success">
                                        <i class="fas fa-check-circle me-2"></i>Olympic Stadium
    </div>
                                    <small class="text-muted">Security sweep completed</small>
                                    <div class="mt-1">
                                        <span class="badge bg-success">Resolved</span>
                                        <small class="text-muted ms-2">12 min ago</small>
            </div>
        </div>
    </div>
</div>

                        <div class="alert-item mb-3 p-3 rounded" style="background: rgba(0, 133, 195, 0.1); border-left: 4px solid #0085C3;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="fw-bold text-info">
                                        <i class="fas fa-info-circle me-2"></i>Transport Hub
                                    </div>
                                    <small class="text-muted">Increased passenger flow detected</small>
                                    <div class="mt-1">
                                        <span class="badge bg-info">Monitoring</span>
                                        <small class="text-muted ms-2">18 min ago</small>
                                    </div>
                                </div>
                            </div>
            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Operations Row 2: Resource Management -->
    <div class="row mb-4">
        <!-- Staff Deployment -->
    <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        <i class="fa-solid fa-users me-2"></i>Staff Deployment
                </h5>
                    <small class="text-subtitle">Real-time staff allocation across venues and functions</small>
            </div>
            <div class="card-body">
                <div class="chart-container">
                        <canvas id="staffDeploymentChart" width="400" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

        <!-- Transportation Flow -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        <i class="fa-solid fa-route me-2"></i>Transportation Flow
                </h5>
                    <small class="text-subtitle">Live transportation network performance and passenger flow</small>
            </div>
            <div class="card-body">
                    <div class="chart-container">
                        <canvas id="transportationChart" width="400" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Operations Row 3: Performance Metrics -->
    <div class="row mb-4">
        <!-- Event Schedule Performance -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        <i class="fa-solid fa-calendar-check me-2"></i>Event Schedule Performance
                </h5>
                    <small class="text-subtitle">On-time performance and schedule adherence across all events</small>
            </div>
            <div class="card-body">
                    <div class="chart-container">
                        <canvas id="schedulePerformanceChart" width="400" height="300"></canvas>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3 text-center">
                            <div class="fw-bold fs-4 text-success">96.2%</div>
                            <small class="text-muted">On-Time Events</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="fw-bold fs-4 text-warning">2.8%</div>
                            <small class="text-muted">Minor Delays</small>
                    </div>
                        <div class="col-md-3 text-center">
                            <div class="fw-bold fs-4 text-info">1.0%</div>
                            <small class="text-muted">Rescheduled</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="fw-bold fs-4 text-primary">247</div>
                            <small class="text-muted">Total Events</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resource Utilization -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        <i class="fa-solid fa-chart-pie me-2"></i>Resource Utilization
                    </h5>
                    <small class="text-subtitle">Current resource allocation efficiency</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="resourceUtilizationChart" width="400" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Operations Row 4: Operational Intelligence -->
    <div class="row mb-4">
    <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        <i class="fa-solid fa-brain me-2"></i>Operational Intelligence Dashboard
                </h5>
                    <small class="text-subtitle">AI-powered insights and predictive analytics for operational optimization</small>
            </div>
            <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="intelligence-card p-4 rounded-3 h-100" style="background: linear-gradient(135deg, rgba(0, 133, 195, 0.1) 0%, rgba(0, 133, 195, 0.05) 100%); border: 1px solid rgba(0, 133, 195, 0.2);">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="intelligence-icon me-3" style="width: 48px; height: 48px; background: rgba(0, 133, 195, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-chart-line" style="color: #0085C3; font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1 fw-bold text-light-contrast">Crowd Flow Prediction</h6>
                                        <span class="badge" style="background: rgba(0, 133, 195, 0.3); color: #0085C3; border: 1px solid rgba(0, 133, 195, 0.4);">Next 2 Hours</span>
                                    </div>
                                </div>
                                <div class="intelligence-details">
                                    <div class="mb-2">
                                        <small class="text-muted">Peak Expected:</small>
                                        <div class="fw-bold text-light-contrast">Olympic Stadium - 15:30</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Capacity Impact:</small>
                                        <div class="text-warning fw-bold">+23% above normal</div>
                                    </div>
                                    <div class="intelligence-recommendation p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                                        <small class="text-muted">Recommendation:</small>
                                        <div class="text-light-contrast">Deploy 3 additional security teams and activate overflow parking</div>
                                    </div>
                        </div>
                    </div>
                        </div>
                        <div class="col-md-4">
                            <div class="intelligence-card p-4 rounded-3 h-100" style="background: linear-gradient(135deg, rgba(0, 133, 195, 0.1) 0%, rgba(0, 133, 195, 0.05) 100%); border: 1px solid rgba(0, 133, 195, 0.2);">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="intelligence-icon me-3" style="width: 48px; height: 48px; background: rgba(0, 133, 195, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-cloud-rain" style="color: #0085C3; font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1 fw-bold text-light-contrast">Weather Impact Analysis</h6>
                                        <span class="badge" style="background: rgba(0, 133, 195, 0.3); color: #0085C3; border: 1px solid rgba(0, 133, 195, 0.4);">Today</span>
                                    </div>
                                </div>
                                <div class="intelligence-details">
                                    <div class="mb-2">
                                        <small class="text-muted">Risk Level:</small>
                                        <div class="fw-bold text-light-contrast">Light Rain - 16:00</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Affected Events:</small>
                                        <div class="text-info fw-bold">3 outdoor events</div>
                                    </div>
                                    <div class="intelligence-recommendation p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                                        <small class="text-muted">Recommendation:</small>
                                        <div class="text-light-contrast">Prepare covered areas and distribute rain gear to spectators</div>
                                    </div>
                        </div>
                    </div>
                        </div>
                        <div class="col-md-4">
                            <div class="intelligence-card p-4 rounded-3 h-100" style="background: linear-gradient(135deg, rgba(0, 133, 195, 0.1) 0%, rgba(0, 133, 195, 0.05) 100%); border: 1px solid rgba(0, 133, 195, 0.2);">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="intelligence-icon me-3" style="width: 48px; height: 48px; background: rgba(0, 133, 195, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-wrench" style="color: #0085C3; font-size: 1.5rem;"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1 fw-bold text-light-contrast">Maintenance Optimization</h6>
                                        <span class="badge" style="background: rgba(0, 133, 195, 0.3); color: #0085C3; border: 1px solid rgba(0, 133, 195, 0.4);">Predictive</span>
                                    </div>
                                </div>
                                <div class="intelligence-details">
                                    <div class="mb-2">
                                        <small class="text-muted">Priority Maintenance:</small>
                                        <div class="fw-bold text-light-contrast">Gymnastics Arena HVAC</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Optimal Window:</small>
                                        <div class="text-success fw-bold">Tonight 22:00-06:00</div>
                                    </div>
                                    <div class="intelligence-recommendation p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                                        <small class="text-muted">Recommendation:</small>
                                        <div class="text-light-contrast">Schedule maintenance team for 6-hour window between events</div>
                    </div>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="olympic-rings">
            <div class="ring ring-blue"></div>
            <div class="ring ring-yellow"></div>
            <div class="ring ring-black"></div>
            <div class="ring ring-green"></div>
            <div class="ring ring-red"></div>
        </div>
        <p class="mt-3 text-olympic-blue fw-semibold">Loading Operational Data...</p>
    </div>
</div>

<style>
/* Operational Dashboard Specific Styles */
.text-light-contrast { 
    color: rgba(255, 255, 255, 0.95) !important; 
}

.text-subtitle { 
    color: rgba(255, 255, 255, 0.8) !important; 
}

.alerts-container {
    max-height: 400px;
    overflow-y: auto;
}

.alert-item {
    transition: all 0.3s ease;
}

.alert-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.intelligence-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.intelligence-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    text-align: center;
}

.olympic-rings {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 20px;
}

.ring {
    width: 40px;
    height: 40px;
    border: 4px solid;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.ring-blue { border-color: #0085C3; animation-delay: 0s; }
.ring-yellow { border-color: #FFB81C; animation-delay: 0.2s; }
.ring-black { border-color: #000000; animation-delay: 0.4s; }
.ring-green { border-color: #00A651; animation-delay: 0.6s; }
.ring-red { border-color: #EE334E; animation-delay: 0.8s; }

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.7; }
}

/* Real-time status indicators */
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    animation: blink 2s infinite;
}

.status-operational { background-color: #00A651; }
.status-warning { background-color: #FFB81C; }
.status-critical { background-color: #EE334E; }

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.5; }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Real-time clock update
function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('currentTime').textContent = timeString;
}

// Update clock every second
setInterval(updateClock, 1000);
updateClock(); // Initial call

// Operational Dashboard Data and Charts
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all operational charts with database data
    loadOperationalData();
    
    // Start real-time data updates
    startRealTimeUpdates();
});

// Load all operational data from database
function loadOperationalData() {
    // Show loading overlay
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // Fetch operational data from database
    Promise.all([
        fetch('/api/operational-data').then(response => response.json()),
        fetch('/api/operational-kpis').then(response => response.json())
    ])
    .then(([operationalData, kpiData]) => {
        // Update KPIs
        updateKPICards(kpiData);
        
        // Initialize charts with database data
        initializeVenueStatusChart(operationalData.venues);
        initializeStaffDeploymentChart(operationalData.staff);
        initializeTransportationChart(operationalData.transportation);
        initializeSchedulePerformanceChart(operationalData.schedule);
        initializeResourceUtilizationChart(operationalData.resources);
        
        // Update alerts and intelligence
        updateAlertsPanel(operationalData.alerts);
        updateIntelligenceCards(operationalData.intelligence);
        
        // Update status indicators
        updateStatusIndicators(operationalData.summary);
        
        // Hide loading overlay
        document.getElementById('loadingOverlay').style.display = 'none';
    })
    .catch(error => {
        console.error('Error loading operational data:', error);
        // Hide loading overlay and show fallback data
        document.getElementById('loadingOverlay').style.display = 'none';
        initializeFallbackCharts();
    });
}

// Update KPI Cards with database data
function updateKPICards(kpiData) {
    document.getElementById('venueCapacityPercent').textContent = kpiData.venue_capacity;
    document.getElementById('transportOnTime').textContent = kpiData.transport_performance;
    document.getElementById('securityLevel').textContent = kpiData.security_level;
    document.getElementById('activeIncidents').textContent = kpiData.active_incidents;
    
    // Update status bar
    document.getElementById('activeEvents').textContent = '12';
    document.getElementById('totalAttendees').textContent = kpiData.total_attendees;
    document.getElementById('activeStaff').textContent = kpiData.active_staff;
    document.getElementById('weatherTemp').textContent = kpiData.weather;
    
    // Update venue counts
    document.getElementById('operationalVenues').textContent = kpiData.operational_venues;
    document.getElementById('maintenanceVenues').textContent = kpiData.maintenance_venues;
    document.getElementById('preparingVenues').textContent = kpiData.preparing_venues;
    
    // Update progress bars
    const capacityPercent = parseInt(kpiData.venue_capacity);
    const transportPercent = parseInt(kpiData.transport_performance);
    document.querySelector('.progress-bar').style.width = capacityPercent + '%';
    document.querySelectorAll('.progress-bar')[1].style.width = transportPercent + '%';
}

// Venue Status Chart with database data
function initializeVenueStatusChart(venueData) {
    const ctx = document.getElementById('venueStatusChart').getContext('2d');
    
    const labels = venueData.map(venue => venue.venue_name);
    const capacityData = venueData.map(venue => venue.capacity_percentage);
    
    const chartData = {
        labels: labels,
        datasets: [{
            label: 'Current Capacity %',
            data: capacityData,
            backgroundColor: [
                '#0085C3', '#00A651', '#FFB81C', '#EE334E', 
                '#0085C3', '#00A651', '#FFB81C', '#EE334E'
            ],
            borderColor: '#ffffff',
            borderWidth: 2,
            borderRadius: 8
        }]
    };

    new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const venue = venueData[context.dataIndex];
                            return [
                                `Capacity: ${context.parsed.y}%`,
                                `Occupancy: ${venue.current_occupancy.toLocaleString()}`,
                                `Total Capacity: ${venue.capacity.toLocaleString()}`,
                                `Status: ${venue.status}`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Staff Deployment Chart with database data
function initializeStaffDeploymentChart(staffData) {
    const ctx = document.getElementById('staffDeploymentChart').getContext('2d');
    
    const labels = staffData.map(staff => staff.department);
    const activeData = staffData.map(staff => staff.active_count);
    
    const chartData = {
        labels: labels,
        datasets: [{
            label: 'Active Staff',
            data: activeData,
            backgroundColor: [
                '#0085C3', '#00A651', '#FFB81C', '#EE334E', 
                '#0085C3', '#00A651', '#FFB81C'
            ],
            borderWidth: 0
        }]
    };

    new Chart(ctx, {
        type: 'doughnut',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const staff = staffData[context.dataIndex];
                            const total = activeData.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed * 100) / total).toFixed(1);
                            return [
                                `${context.label}: ${context.parsed} active`,
                                `Total Assigned: ${staff.total_assigned}`,
                                `Percentage: ${percentage}%`
                            ];
                        }
                    }
                }
            }
        }
    });
}

// Transportation Chart with database data
function initializeTransportationChart(transportData) {
    const ctx = document.getElementById('transportationChart').getContext('2d');
    
    const labels = transportData.map(transport => transport.time_slot);
    const passengerData = transportData.map(transport => transport.passenger_count);
    const onTimeData = transportData.map(transport => transport.on_time_percentage);
    
    const chartData = {
        labels: labels,
            datasets: [{
            label: 'Passenger Flow',
            data: passengerData,
            borderColor: '#0085C3',
            backgroundColor: 'rgba(0, 133, 195, 0.1)',
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#0085C3',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6
        }, {
            label: 'On-Time Performance %',
            data: onTimeData,
            borderColor: '#00A651',
            backgroundColor: 'rgba(0, 166, 81, 0.1)',
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#00A651',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6,
            yAxisID: 'y1'
        }]
    };

    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                title: {
                        display: true,
                        text: 'Passengers'
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'On-Time %'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    min: 80,
                    max: 100
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Schedule Performance Chart with database data
function initializeSchedulePerformanceChart(scheduleData) {
    const ctx = document.getElementById('schedulePerformanceChart').getContext('2d');
    
    const labels = scheduleData.map(schedule => schedule.day_of_week.substring(0, 3));
    const onTimeData = scheduleData.map(schedule => schedule.on_time_events);
    const minorDelayData = scheduleData.map(schedule => schedule.minor_delays);
    const majorDelayData = scheduleData.map(schedule => schedule.major_delays);
    
    const chartData = {
        labels: labels,
        datasets: [{
            label: 'On-Time Events',
            data: onTimeData,
            backgroundColor: '#00A651',
            borderRadius: 6
        }, {
            label: 'Minor Delays',
            data: minorDelayData,
            backgroundColor: '#FFB81C',
            borderRadius: 6
        }, {
            label: 'Major Delays',
            data: majorDelayData,
            backgroundColor: '#EE334E',
            borderRadius: 6
        }]
    };

    new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                x: {
                    stacked: true,
                    grid: {
                        display: false
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Number of Events'
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

// Resource Utilization Chart with database data
function initializeResourceUtilizationChart(resourceData) {
    const ctx = document.getElementById('resourceUtilizationChart').getContext('2d');
    
    const labels = resourceData.map(resource => resource.resource_type);
    const utilizationData = resourceData.map(resource => resource.utilization_percentage);
    
    const chartData = {
        labels: labels,
            datasets: [{
            label: 'Utilization %',
            data: utilizationData,
            backgroundColor: [
                '#0085C3', '#00A651', '#FFB81C', '#EE334E', '#0085C3'
            ],
            borderWidth: 0
        }]
    };

    new Chart(ctx, {
        type: 'polarArea',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true
                    }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// Update Alerts Panel with database data
function updateAlertsPanel(alertsData) {
    const alertsContainer = document.getElementById('alertsList');
    alertsContainer.innerHTML = '';
    
    alertsData.forEach(alert => {
        const alertElement = document.createElement('div');
        const priorityColor = getPriorityColor(alert.priority_level);
        const statusIcon = getStatusIcon(alert.status);
        const timeAgo = Math.round(alert.minutes_ago);
        
        alertElement.className = 'alert-item mb-3 p-3 rounded';
        alertElement.style.cssText = `background: ${priorityColor.bg}; border-left: 4px solid ${priorityColor.border};`;
        
        alertElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="fw-bold" style="color: ${priorityColor.text};">
                        ${statusIcon} ${alert.venue_name}
                    </div>
                    <small class="text-muted">${alert.description}</small>
                    <div class="mt-1">
                        <span class="badge" style="background-color: ${priorityColor.border}; color: white;">${alert.priority_level} Priority</span>
                        <small class="text-muted ms-2">${timeAgo} min ago</small>
                    </div>
                </div>
            </div>
        `;
        
        alertsContainer.appendChild(alertElement);
    });
}

// Update Intelligence Cards with database data
function updateIntelligenceCards(intelligenceData) {
    // This would update the operational intelligence cards
    // For now, keeping the existing static cards as they demonstrate the concept well
    console.log('Intelligence data loaded:', intelligenceData);
}

// Helper functions
function getPriorityColor(priority) {
    switch(priority.toLowerCase()) {
        case 'high':
            return { bg: 'rgba(238, 51, 78, 0.1)', border: '#EE334E', text: '#EE334E' };
        case 'medium':
            return { bg: 'rgba(255, 184, 28, 0.1)', border: '#FFB81C', text: '#FFB81C' };
        case 'low':
            return { bg: 'rgba(0, 166, 81, 0.1)', border: '#00A651', text: '#00A651' };
        default:
            return { bg: 'rgba(0, 133, 195, 0.1)', border: '#0085C3', text: '#0085C3' };
    }
}

function getStatusIcon(status) {
    switch(status.toLowerCase()) {
        case 'resolved':
            return '<i class="fas fa-check-circle me-2"></i>';
        case 'active':
            return '<i class="fas fa-exclamation-triangle me-2"></i>';
        case 'monitoring':
            return '<i class="fas fa-info-circle me-2"></i>';
        default:
            return '<i class="fas fa-bell me-2"></i>';
    }
}

// Update status indicators
function updateStatusIndicators(summary) {
    if (summary) {
        console.log('Dashboard summary:', summary);
    }
}

// Fallback charts with original fake data (in case database fails)
function initializeFallbackCharts() {
    console.log('Loading fallback charts...');
    // Original chart initialization code would go here as backup
}

// Real-time updates simulation
function startRealTimeUpdates() {
    setInterval(() => {
        // Simulate real-time data updates
        updateKPIValues();
        updateAlerts();
    }, 30000); // Update every 30 seconds
}

function updateKPIValues() {
    // Simulate minor fluctuations in KPI values
    const venueCapacity = Math.floor(Math.random() * 10) + 85;
    const transportOnTime = Math.floor(Math.random() * 5) + 92;
    const activeIncidents = Math.floor(Math.random() * 3) + 1;
    
    document.getElementById('venueCapacityPercent').textContent = venueCapacity + '%';
    document.getElementById('transportOnTime').textContent = transportOnTime + '%';
    document.getElementById('activeIncidents').textContent = activeIncidents;
    
    // Update progress bars
    document.querySelector('.progress-bar').style.width = venueCapacity + '%';
}

function updateAlerts() {
    // This would typically fetch new alerts from the server
    console.log('Checking for new alerts...');
}

// Export and refresh functions
function exportOperationalData() {
    alert('Exporting operational report... (This would generate a comprehensive PDF report)');
}

function refreshOperationalDashboard() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    setTimeout(() => {
        // Simulate data refresh
        location.reload();
    }, 2000);
}
</script>
{% endblock %} 