{% extends "base.html" %}

{% block title %}Operational Dashboard - Olympic Data{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-5 fw-bold text-success">
                <i class="fas fa-cogs"></i> Operational Dashboard
            </h1>
            <div class="olympic-rings">
                <div class="ring ring-blue"></div>
                <div class="ring ring-yellow"></div>
                <div class="ring ring-black"></div>
                <div class="ring ring-green"></div>
                <div class="ring ring-red"></div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="filter-container">
    <div class="row align-items-end">
        <div class="col-md-3">
            <label class="form-label fw-bold">
                <i class="fas fa-calendar"></i> Year
            </label>
            <select id="yearFilter" class="form-select">
                <option value="">All Years</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">
                <i class="fas fa-running"></i> Sport
            </label>
            <select id="sportFilter" class="form-select">
                <option value="">All Sports</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">
                <i class="fas fa-globe"></i> Country
            </label>
            <select id="countryFilter" class="form-select">
                <option value="">All Countries</option>
            </select>
        </div>
        <div class="col-md-3">
            <button id="updateBtn" class="btn btn-primary w-100">
                <i class="fas fa-sync-alt"></i> Update Dashboard
            </button>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body stat-card">
                <div class="stat-number" id="totalEvents">0</div>
                <div class="stat-label">Total Events</div>
                <i class="fas fa-calendar-check fa-2x opacity-25 position-absolute top-0 end-0 m-3"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body stat-card">
                <div class="stat-number" id="totalAthletes">0</div>
                <div class="stat-label">Active Athletes</div>
                <i class="fas fa-users fa-2x opacity-25 position-absolute top-0 end-0 m-3"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body stat-card">
                <div class="stat-number" id="totalSports">0</div>
                <div class="stat-label">Sports Categories</div>
                <i class="fas fa-medal fa-2x opacity-25 position-absolute top-0 end-0 m-3"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-danger text-white">
            <div class="card-body stat-card">
                <div class="stat-number" id="topSport">-</div>
                <div class="stat-label">Most Popular Sport</div>
                <i class="fas fa-star fa-2x opacity-25 position-absolute top-0 end-0 m-3"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar"></i> Events by Sport
                </h5>
            </div>
            <div class="card-body">
                <div class="loading" id="eventsLoading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading events data...</p>
                </div>
                <div class="chart-container">
                    <canvas id="eventsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie"></i> Sport Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="sportDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Athlete Performance Section -->
<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy"></i> Top Performing Athletes
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Athlete</th>
                                <th>Country</th>
                                <th>Medals</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody id="athletesTable">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line"></i> Performance Metrics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-12 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-primary mb-1" id="avgMedalsPerAthlete">0</h4>
                            <small class="text-muted">Avg Medals/Athlete</small>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-success mb-1" id="medalistPercentage">0%</h4>
                            <small class="text-muted">Medalist Rate</small>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-warning mb-1" id="eventsPerSport">0</h4>
                            <small class="text-muted">Avg Events/Sport</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Operational Status -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt"></i> Operational Status & Insights
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                            <h6>Events Status</h6>
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <i class="fas fa-users text-info fa-2x mb-2"></i>
                            <h6>Athlete Registration</h6>
                            <span class="badge bg-info">Open</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <i class="fas fa-medal text-warning fa-2x mb-2"></i>
                            <h6>Medal Distribution</h6>
                            <span class="badge bg-warning">In Progress</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <i class="fas fa-globe text-primary fa-2x mb-2"></i>
                            <h6>Global Participation</h6>
                            <span class="badge bg-primary">Excellent</span>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-exclamation-triangle text-warning"></i> Operational Alerts</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <span class="badge bg-success me-2">âœ“</span>
                                All systems operational
                            </li>
                            <li class="mb-2">
                                <span class="badge bg-info me-2">i</span>
                                Peak participation in Swimming & Athletics
                            </li>
                            <li class="mb-2">
                                <span class="badge bg-warning me-2">!</span>
                                Monitor medal distribution progress
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-lightbulb text-info"></i> Operational Insights</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-arrow-up text-success"></i>
                                High athlete performance in current season
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-chart-line text-primary"></i>
                                Consistent event scheduling across sports
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-globe text-info"></i>
                                Strong international participation
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let eventsChart, sportDistributionChart;

document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    loadDashboard();
    
    document.getElementById('updateBtn').addEventListener('click', loadDashboard);
});

async function initializeFilters() {
    try {
        const response = await fetch('/api/filters');
        const filters = await response.json();
        
        // Populate dropdowns
        populateSelect('yearFilter', filters.years);
        populateSelect('sportFilter', filters.sports);
        populateSelect('countryFilter', filters.countries);
    } catch (error) {
        console.error('Error loading filters:', error);
    }
}

function populateSelect(selectId, options) {
    const select = document.getElementById(selectId);
    const currentValue = select.value;
    
    // Clear existing options except the first one
    while (select.children.length > 1) {
        select.removeChild(select.lastChild);
    }
    
    // Add new options
    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
    });
    
    // Restore previous selection if it exists
    if (currentValue && options.includes(currentValue)) {
        select.value = currentValue;
    }
}

async function loadDashboard() {
    showLoading('eventsLoading');
    
    const year = document.getElementById('yearFilter').value;
    const sport = document.getElementById('sportFilter').value;
    
    const params = new URLSearchParams();
    if (year) params.append('year', year);
    if (sport) params.append('sport', sport);
    
    try {
        const response = await fetch(`/api/operational-data?${params}`);
        const data = await response.json();
        
        updateMetrics(data);
        updateEventsChart(data.events);
        updateSportDistributionChart(data.events);
        updateAthletesTable(data.performance);
        updatePerformanceMetrics(data);
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    } finally {
        hideLoading('eventsLoading');
    }
}

function updateMetrics(data) {
    const totalEvents = data.events.reduce((sum, sport) => sum + sport.event_count, 0);
    const totalAthletes = data.performance.length;
    const totalSports = data.events.length;
    const topSport = data.events.length > 0 ? data.events[0].sportname : '-';
    
    animateCounter(document.getElementById('totalEvents'), totalEvents);
    animateCounter(document.getElementById('totalAthletes'), totalAthletes);
    animateCounter(document.getElementById('totalSports'), totalSports);
    document.getElementById('topSport').textContent = topSport;
}

function updateEventsChart(events) {
    const ctx = document.getElementById('eventsChart').getContext('2d');
    
    if (eventsChart) {
        eventsChart.destroy();
    }
    
    const top10 = events.slice(0, 10);
    
    eventsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top10.map(sport => sport.sportname),
            datasets: [{
                label: 'Number of Events',
                data: top10.map(sport => sport.event_count),
                backgroundColor: [
                    olympicColors.blue,
                    olympicColors.green,
                    olympicColors.red,
                    olympicColors.yellow,
                    olympicColors.black,
                    olympicColors.blue + '80',
                    olympicColors.green + '80',
                    olympicColors.red + '80',
                    olympicColors.yellow + '80',
                    olympicColors.black + '80'
                ],
                borderColor: olympicColors.blue,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                title: {
                    display: true,
                    text: 'Events Distribution by Sport'
                },
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Events'
                    }
                }
            }
        }
    });
}

function updateSportDistributionChart(events) {
    const ctx = document.getElementById('sportDistributionChart').getContext('2d');
    
    if (sportDistributionChart) {
        sportDistributionChart.destroy();
    }
    
    const top8 = events.slice(0, 8);
    const colors = [
        olympicColors.blue,
        olympicColors.green,
        olympicColors.red,
        olympicColors.yellow,
        olympicColors.black,
        '#FF6B6B',
        '#4ECDC4',
        '#45B7D1'
    ];
    
    sportDistributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: top8.map(sport => sport.sportname),
            datasets: [{
                data: top8.map(sport => sport.event_count),
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 10
                    }
                }
            }
        }
    });
}

function updateAthletesTable(athletes) {
    const tbody = document.getElementById('athletesTable');
    tbody.innerHTML = '';
    
    athletes.slice(0, 15).forEach((athlete, index) => {
        const row = document.createElement('tr');
        const performanceBar = `
            <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" role="progressbar" 
                     style="width: ${Math.min(athlete.medals * 10, 100)}%" 
                     aria-valuenow="${athlete.medals}" aria-valuemin="0" aria-valuemax="10">
                    ${athlete.medals}
                </div>
            </div>
        `;
        
        row.innerHTML = `
            <td><span class="badge bg-primary">${index + 1}</span></td>
            <td><strong>${athlete.fullname}</strong></td>
            <td>
                <span class="badge bg-light text-dark">${athlete.countryname}</span>
            </td>
            <td><span class="badge bg-success">${athlete.medals}</span></td>
            <td>${performanceBar}</td>
        `;
        tbody.appendChild(row);
    });
}

function updatePerformanceMetrics(data) {
    if (data.performance.length > 0) {
        const totalMedals = data.performance.reduce((sum, athlete) => sum + athlete.medals, 0);
        const avgMedals = (totalMedals / data.performance.length).toFixed(2);
        const medalists = data.performance.filter(athlete => athlete.medals > 0).length;
        const medalistRate = ((medalists / data.performance.length) * 100).toFixed(1);
        
        document.getElementById('avgMedalsPerAthlete').textContent = avgMedals;
        document.getElementById('medalistPercentage').textContent = medalistRate + '%';
    }
    
    if (data.events.length > 0) {
        const totalEvents = data.events.reduce((sum, sport) => sum + sport.event_count, 0);
        const avgEvents = (totalEvents / data.events.length).toFixed(1);
        document.getElementById('eventsPerSport').textContent = avgEvents;
    }
}
</script>
{% endblock %} 