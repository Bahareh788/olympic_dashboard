{% extends "base.html" %}

{% block title %}Strategic Dashboard - Olympic Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold mb-1" style="color: #0085C3;">
                        <i class="fa-solid fa-chart-line me-2"></i>Strategic Dashboard
                    </h1>
                    <p class="text-muted mb-0">Long-term Olympic performance analysis and planning</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-light d-flex align-items-center gap-2 dashboard-btn" style="border: 1px solid #0085C3; color: #0085C3;" onclick="exportStrategicData()">
                        <i class="fa-solid fa-download"></i>
                        Export Data
                    </button>
                    <button class="btn d-flex align-items-center gap-2 dashboard-btn" style="background-color: #0085C3; color: white;" onclick="refreshStrategicDashboard()">
                        <i class="fa-solid fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-semibold text-olympic-blue">Olympic Year</label>
                            <select class="form-select" id="yearFilter">
                                <option value="">All Years</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold text-olympic-blue">Country</label>
                            <select class="form-select" id="countryFilter">
                                <option value="">All Countries</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold text-olympic-blue">Sport</label>
                            <select class="form-select" id="sportFilter">
                                <option value="">All Sports</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-olympic-blue w-100" onclick="applyFilters()">
                                <i class="fa-solid fa-filter me-2"></i>Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategic Insights KPI Cards Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 kpi-card" style="background: linear-gradient(135deg, #0085C3 0%, #00A651 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Top Opportunity</h6>
                            <h3 class="mb-1 fw-bold" id="topOpportunityCard">Swimming</h3>
                            <small class="text-white-75" id="topOpportunityDesc">85% medal probability</small>
                            <div class="kpi-trend mt-1">
                                <span class="small">Focus investment here</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 kpi-card" style="background: linear-gradient(135deg, #FFB81C 0%, #EE334E 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Biggest Risk</h6>
                            <h3 class="mb-1 fw-bold" id="biggestRiskCard">Athletics</h3>
                            <small class="text-white-75" id="biggestRiskDesc">Declining performance</small>
                            <div class="kpi-trend mt-1">
                                <span class="small">Needs immediate attention</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 kpi-card" style="background: linear-gradient(135deg, #EE334E 0%, #000000 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Hidden Gem</h6>
                            <h3 class="mb-1 fw-bold" id="hiddenGemCard">Cycling</h3>
                            <small class="text-white-75" id="hiddenGemDesc">Emerging potential</small>
                            <div class="kpi-trend mt-1">
                                <span class="small">Invest for future growth</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 kpi-card" style="background: linear-gradient(135deg, #00A651 0%, #0085C3 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-1">Quick Win</h6>
                            <h3 class="mb-1 fw-bold" id="quickWinCard">Gymnastics</h3>
                            <small class="text-white-75" id="quickWinDesc">Low competition, high medals</small>
                            <div class="kpi-trend mt-1">
                                <span class="small">Easy medal opportunity</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategic Story Row 1: Performance Context -->
    <div class="row mb-4">
        <!-- Country Medal Efficiency Benchmarking - Bubble Chart -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        Medal Efficiency Benchmarking
                    </h5>
                    <small class="text-subtitle">How efficiently do countries convert athletes to medals?</small>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="efficiencyBenchmarkChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategic Recommendations Panel -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        Strategic Insights
                    </h5>
                    <small class="text-subtitle">AI-powered recommendations</small>
                </div>
                <div class="card-body" style="height: calc(350px - 73px);">
                    <div id="strategicInsights" class="insights-container h-100">
                        <div class="text-center mb-3" id="insightCountryDisplay">
                            <div class="badge fs-6 px-3 py-2" style="background: linear-gradient(90deg, #0085C3 0%, #00A651 100%);">
                                <span id="selectedCountryName">Click a bubble to view insights</span>
                            </div>
                        </div>
                        
                        <div class="insight-item mb-3">
                            <div class="insight-header">
                                <strong>Efficiency</strong>
                            </div>
                            <p class="insight-text small mb-2" id="efficiencyInsight">Click to view medal efficiency analysis and ranking.</p>
                        </div>
                        
                        <div class="insight-item mb-3">
                            <div class="insight-header">
                                <strong>Medal Potential</strong>
                            </div>
                            <p class="insight-text small mb-2" id="medalInsight">Click to see medal projections and opportunities.</p>
                        </div>
                        
                        <div class="insight-item mb-3">
                            <div class="insight-header">
                                <strong>Growth Strategy</strong>
                            </div>
                            <p class="insight-text small mb-2" id="growthInsight">Click to get sport portfolio recommendations.</p>
                        </div>
                        
                        <div class="insight-item">
                            <div class="insight-header">
                                <strong>Resource Focus</strong>
                            </div>
                            <p class="insight-text small" id="resourceInsight">Click to view resource allocation strategy.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategic Story Row 2: Sport Portfolio Analysis -->
    <div class="row mb-4">
        <!-- Global Sport Opportunity Matrix -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        <i class="fa-solid fa-medal me-2"></i>Medal ROI by Sport
                    </h5>
                    <small class="text-subtitle">Which sports offer the best medal ROI opportunities globally?</small>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="sportOpportunityChart"></canvas>
                    </div>
                    <div class="sport-insights mt-2">
                        <div class="row g-2">
                            <div class="col-4">
                                <div class="insight-card bg-light rounded p-2 text-center">
                                    <i class="fas fa-star text-warning"></i>
                                    <div class="small fw-bold mt-1">Swimming</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">Highest Opportunity</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="insight-card bg-light rounded p-2 text-center">
                                    <i class="fas fa-chart-line text-info"></i>
                                    <div class="small fw-bold mt-1">Rowing</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">Emerging Potential</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="insight-card bg-light rounded p-2 text-center">
                                    <i class="fas fa-exclamation-triangle text-danger"></i>
                                    <div class="small fw-bold mt-1">Boxing</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">Needs Attention</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Performance Trends -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        <i class="fa-solid fa-chart-line me-2"></i>Medal Trends by Country
                    </h5>
                    <small class="text-subtitle">How top Olympic nations are performing over time</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="performanceTrendChart" width="400" height="300"></canvas>
                    </div>
                    <div class="sport-insights mt-2">
                        <div class="row g-2">
                            <div class="col-4">
                                <div class="insight-card bg-light rounded p-2 text-center">
                                    <i class="fas fa-arrow-trend-up text-success"></i>
                                    <div class="small fw-bold mt-1">7</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">Rising Nations</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="insight-card bg-light rounded p-2 text-center">
                                    <i class="fas fa-equals text-warning"></i>
                                    <div class="small fw-bold mt-1">1</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">Stable Powers</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="insight-card bg-light rounded p-2 text-center">
                                    <i class="fas fa-arrow-trend-down text-danger"></i>
                                    <div class="small fw-bold mt-1">0</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">Declining Nations</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategic Story Row 3: Competitive Intelligence & Future Planning -->
    <div class="row mb-4">
        <!-- Performance Gap Analysis -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-light-contrast mb-0">
                                <i class="fa-solid fa-trophy me-2"></i>Top Countries by Medal Efficiency
                            </h5>
                            <small class="text-subtitle">Countries achieving the most medals per athlete</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="competitiveBenchmarkChart" width="400" height="300"></canvas>
                    </div>
                    <div class="efficiency-insights mt-3">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="efficiency-stat text-center">
                                    <div class="stat-value fw-bold mb-0 text-success" style="font-size: 0.95rem;" id="topEfficiencyRate">0.85</div>
                                    <div class="stat-label text-muted" style="font-size: 0.75rem;">Best Efficiency</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="efficiency-stat text-center">
                                    <div class="stat-value fw-bold mb-0 text-info" style="font-size: 0.95rem;" id="avgEfficiencyRate">0.32</div>
                                    <div class="stat-label text-muted" style="font-size: 0.75rem;">Average Rate</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="efficiency-stat text-center">
                                    <div class="stat-value fw-bold mb-0 text-warning" style="font-size: 0.95rem;" id="topEfficiencyCountry">Norway</div>
                                    <div class="stat-label text-muted" style="font-size: 0.75rem;">Efficiency Leader</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="efficiency-stat text-center">
                                    <div class="stat-value fw-bold mb-0 text-primary" style="font-size: 0.95rem;" id="totalAnalyzedCountries">25</div>
                                    <div class="stat-label text-muted" style="font-size: 0.75rem;">Countries</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sport Portfolio Risk Assessment -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title text-light-contrast mb-0">
                        <i class="fa-solid fa-shield-halved me-2"></i>Risk vs Reward by Sport
                    </h5>
                    <small class="text-subtitle">Investment risk vs. medal potential by sport category</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="sportPortfolioChart" width="400" height="300"></canvas>
                    </div>
                    <div class="portfolio-insights mt-3">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="portfolio-stat text-center">
                                    <div class="stat-value fw-bold mb-0 text-success" style="font-size: 0.95rem;" id="lowRiskSports">8</div>
                                    <div class="stat-label text-muted" style="font-size: 0.75rem;">Low Risk</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="portfolio-stat text-center">
                                    <div class="stat-value fw-bold mb-0 text-warning" style="font-size: 0.95rem;" id="mediumRiskSports">12</div>
                                    <div class="stat-label text-muted" style="font-size: 0.75rem;">Medium Risk</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="portfolio-stat text-center">
                                    <div class="stat-value fw-bold mb-0 text-danger" style="font-size: 0.95rem;" id="highRiskSports">5</div>
                                    <div class="stat-label text-muted" style="font-size: 0.75rem;">High Risk</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="portfolio-stat text-center">
                                    <div class="stat-value fw-bold mb-0 text-info" style="font-size: 0.95rem;" id="bestROISport">Swimming</div>
                                    <div class="stat-label text-muted" style="font-size: 0.75rem;">Best ROI</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Strategic Summary Table - Following Decision Structure for Organized Data -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover strategic-summary-table">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-white fw-bold">Strategic Focus Area</th>
                                    <th class="text-white fw-bold">Current Status</th>
                                    <th class="text-white fw-bold">Industry Benchmark</th>
                                    <th class="text-white fw-bold">Impact Level</th>
                                    <th class="text-white fw-bold">Action Priority</th>
                                    <th class="text-white fw-bold">Suggested Action</th>
                                </tr>
                            </thead>
                            <tbody id="strategicSummaryTable">
                                <tr>
                                    <td class="text-dark fw-semibold">Top Opportunity Pursuit</td>
                                    <td><span id="topOpportunityStatus" class="fw-bold text-dark">Swimming Focus</span></td>
                                    <td><span id="topOpportunityBenchmark" class="text-dark">32.5% Global ROI</span></td>
                                    <td><span class="text-success fw-bold">High Impact</span></td>
                                    <td><span class="badge bg-success">Priority 1</span></td>
                                    <td><span class="text-dark">Increase investment in swimming programs by 25%</span></td>
                                </tr>
                                <tr>
                                    <td class="text-dark fw-semibold">Risk Mitigation</td>
                                    <td><span id="riskMitigationStatus" class="fw-bold text-dark">Athletics Decline</span></td>
                                    <td><span id="riskMitigationBenchmark" class="text-dark">High Competition</span></td>
                                    <td><span class="text-warning fw-bold">Medium Impact</span></td>
                                    <td><span class="badge bg-warning">Priority 2</span></td>
                                    <td><span class="text-dark">Diversify into niche athletics events with lower competition</span></td>
                                </tr>
                                <tr>
                                    <td class="text-dark fw-semibold">Hidden Gem Development</td>
                                    <td><span id="hiddenGemStatus" class="fw-bold text-dark">Rowing Potential</span></td>
                                    <td><span id="hiddenGemBenchmark" class="text-dark">22.7% ROI, Low Competition</span></td>
                                    <td><span class="text-success fw-bold">High Impact</span></td>
                                    <td><span class="badge bg-info">Priority 1</span></td>
                                    <td><span class="text-dark">Establish rowing development program in next 2 years</span></td>
                                </tr>
                                <tr>
                                    <td class="text-dark fw-semibold">Quick Win Execution</td>
                                    <td><span id="quickWinStatus" class="fw-bold text-dark">Shooting Expansion</span></td>
                                    <td><span id="quickWinBenchmark" class="text-dark">21.3% ROI, Low Competition</span></td>
                                    <td><span class="text-info fw-bold">Medium Impact</span></td>
                                    <td><span class="badge bg-primary">Priority 3</span></td>
                                    <td><span class="text-dark">Fast-track 3-5 shooting athletes for immediate results</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="strategic-implementation mt-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="implementation-timeline p-3 rounded" style="background: rgba(0, 166, 81, 0.1); border-left: 4px solid #00A651;">
                                    <h6 class="text-success mb-2">
                                        <i class="fas fa-calendar-check me-2"></i>Immediate Actions (0-6 months)
                                    </h6>
                                    <ul class="list-unstyled mb-0 small">
                                        <li class="mb-1">• Reallocate 25% budget to swimming programs</li>
                                        <li class="mb-1">• Recruit 3-5 shooting athletes for quick wins</li>
                                        <li class="mb-1">• Assess current athletics portfolio risks</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="implementation-timeline p-3 rounded" style="background: rgba(255, 184, 28, 0.1); border-left: 4px solid #FFB81C;">
                                    <h6 class="text-warning mb-2">
                                        <i class="fas fa-clock me-2"></i>Medium-term (6-18 months)
                                    </h6>
                                    <ul class="list-unstyled mb-0 small">
                                        <li class="mb-1">• Launch rowing development program</li>
                                        <li class="mb-1">• Diversify athletics into niche events</li>
                                        <li class="mb-1">• Monitor portfolio risk concentration</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="implementation-timeline p-3 rounded" style="background: rgba(0, 133, 195, 0.1); border-left: 4px solid #0085C3;">
                                    <h6 class="text-info mb-2">
                                        <i class="fas fa-target me-2"></i>Long-term (18+ months)
                                    </h6>
                                    <ul class="list-unstyled mb-0 small">
                                        <li class="mb-1">• Establish rowing as core competency</li>
                                        <li class="mb-1">• Evaluate new emerging sport opportunities</li>
                                        <li class="mb-1">• Reassess strategic positioning annually</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="olympic-rings">
            <div class="ring ring-blue"></div>
            <div class="ring ring-yellow"></div>
            <div class="ring ring-black"></div>
            <div class="ring ring-green"></div>
            <div class="ring ring-red"></div>
        </div>
        <p class="mt-3 text-olympic-blue fw-semibold">Loading Strategic Analytics...</p>
    </div>
</div>

<style>
/* Olympic Color Scheme */
.text-olympic-blue { color: #0085C3 !important; }
.text-olympic-yellow { color: #FFB81C !important; }
.text-olympic-black { color: #000000 !important; }
.text-olympic-green { color: #00A651 !important; }
.text-olympic-red { color: #EE334E !important; }

/* Light text for better contrast against dark backgrounds */
.text-light-contrast { 
    color: rgba(255, 255, 255, 0.9) !important; 
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.text-subtitle { 
    color: rgba(255, 255, 255, 0.8) !important; 
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
}

.btn-olympic-blue {
    background-color: #0085C3;
    border-color: #0085C3;
    color: white;
}

.btn-olympic-blue:hover {
    background-color: #006a9e;
    border-color: #006a9e;
    color: white;
}

.btn-outline-olympic-blue {
    color: #0085C3;
    border-color: #0085C3;
}

.btn-outline-olympic-blue:hover {
    background-color: #0085C3;
    border-color: #0085C3;
    color: white;
}

/* KPI Cards */
.kpi-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
}

/* KPI Icon containers */
.kpi-card .bg-white {
    min-width: 50px;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.kpi-card .fa-solid {
    color: rgba(255, 255, 255, 0.95) !important;
    font-size: 1.5rem !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.kpi-card .fa-2x {
    font-size: 2rem !important;
}

/* Chart Containers */
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

/* Timeline Styles */
.timeline-container {
    position: relative;
    max-height: 300px;
    overflow-y: auto;
}

.timeline-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    position: relative;
}

.timeline-marker {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 15px;
    margin-top: 5px;
    position: relative;
    z-index: 2;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.timeline-marker::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 12px;
    width: 2px;
    height: 40px;
    background-color: #dee2e6;
    transform: translateX(-50%);
}

.timeline-item:last-child .timeline-marker::after {
    display: none;
}

.timeline-content {
    flex: 1;
}

.timeline-year {
    font-size: 1.1rem;
    margin-bottom: 2px;
}

.timeline-event {
    font-weight: 500;
    margin-bottom: 2px;
}

.timeline-description {
    font-size: 0.9rem;
}

/* Heatmap Styles */
.heatmap-container {
    height: 300px;
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    overflow-y: auto;
}

.heatmap-cell {
    flex: 1 1 120px;
    min-height: 40px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s ease;
    margin-bottom: 5px;
    position: relative;
}

.heatmap-cell:hover {
    transform: scale(1.05);
}

.heatmap-cell .country-name {
    text-align: center;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.heatmap-cell .efficiency-value {
    position: absolute;
    bottom: 2px;
    right: 4px;
    font-size: 0.7rem;
    background: rgba(0,0,0,0.3);
    padding: 1px 3px;
    border-radius: 2px;
}

/* Sunburst Styles */
.sunburst-container {
    height: 300px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 10px;
}

.sunburst-container .chart-container {
    height: 250px;
    width: 100%;
    max-width: 250px;
    position: relative;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
}

.loading-spinner {
    text-align: center;
}

/* Olympic Rings Animation */
.olympic-rings {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.ring {
    width: 30px;
    height: 30px;
    border: 3px solid;
    border-radius: 50%;
    animation: ringPulse 2s ease-in-out infinite;
}

.ring-blue { border-color: #0085C3; animation-delay: 0s; }
.ring-yellow { border-color: #FFB81C; animation-delay: 0.2s; }
.ring-black { border-color: #000000; animation-delay: 0.4s; }
.ring-green { border-color: #00A651; animation-delay: 0.6s; }
.ring-red { border-color: #EE334E; animation-delay: 0.8s; }

@keyframes ringPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
}

/* NOC Strategic Dashboard Enhancements */
.noc-efficiency-card, .noc-ranking-card, .noc-portfolio-card, .noc-investment-card {
    position: relative;
    overflow: hidden;
}

.noc-efficiency-card::before, .noc-ranking-card::before, 
.noc-portfolio-card::before, .noc-investment-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}

.kpi-trend {
    font-size: 0.75rem;
    opacity: 0.9;
}

.kpi-trend i {
    font-size: 0.7rem;
    margin-right: 0.25rem;
}

/* Chart Insights Styling */
.chart-insights {
    background: rgba(0, 133, 195, 0.05);
    border-radius: 10px;
    padding: 1rem;
    border: 1px solid rgba(0, 133, 195, 0.1);
}

.insight-metric, .opportunity-metric, .trend-metric {
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 8px;
    transition: transform 0.2s ease;
}

.insight-metric:hover, .opportunity-metric:hover, .trend-metric:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.metric-value {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.metric-label {
    color: #6c757d;
    font-size: 0.8rem;
    font-weight: 500;
}

.metric-icon {
    margin-bottom: 0.5rem;
}

/* Strategic Insights Panel */
.insights-container {
    max-height: 350px;
    overflow-y: auto;
}

.insight-item {
    background: #fff;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 12px;
    border-left: 2px solid #ddd;
}

.insight-header {
    margin-bottom: 8px;
}

.insight-text {
    color: #666;
    line-height: 1.4;
}

/* Remove all hover effects and animations */
.insight-item:hover {
    transform: none;
    background: #fff;
}

/* Remove colored borders */
.insight-item:nth-child(1),
.insight-item:nth-child(2),
.insight-item:nth-child(3),
.insight-item:nth-child(4) {
    border-left-color: #ddd;
}

.insight-item:nth-child(1) { border-left-color: #00A651; }
.insight-item:nth-child(2) { border-left-color: #FFB81C; }
.insight-item:nth-child(3) { border-left-color: #0085C3; }
.insight-item:nth-child(4) { border-left-color: #EE334E; }

.insight-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.insight-text {
    color: #2c3e50 !important;
    line-height: 1.4;
    font-weight: 500;
}

/* Ensure insight text is always readable */
.insight-text strong {
    color: #1a252f !important;
    font-weight: 700;
}

/* Sport Insights Styling */
.sport-insights {
    background: linear-gradient(135deg, rgba(0, 133, 195, 0.1) 0%, rgba(0, 166, 81, 0.1) 100%);
    border-radius: 10px;
    padding: 1rem;
}

/* Benchmark Legend */
.benchmark-legend {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.75rem;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    margin-right: 0.5rem;
    display: inline-block;
}

.legend-label {
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
}

/* Prediction Controls */
.prediction-controls {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 1rem;
}

.form-range {
    background: transparent;
}

.form-range::-webkit-slider-track {
    background: rgba(0, 133, 195, 0.3);
    border-radius: 5px;
    height: 6px;
}

.form-range::-webkit-slider-thumb {
    background: #0085C3;
    border: 2px solid white;
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.prediction-result {
    background: rgba(0, 133, 195, 0.1);
    border-radius: 8px;
    padding: 0.75rem;
    border: 1px solid rgba(0, 133, 195, 0.2);
}

.predicted-medals {
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

/* Trend Summary */
.trend-summary {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.75rem;
}

/* Enhanced Chart Containers */
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    padding: 0.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .chart-container {
        height: 250px;
    }
    
    .chart-insights, .sport-insights, .benchmark-legend, 
    .prediction-controls, .trend-summary {
        padding: 0.5rem;
    }
    
    .insight-metric, .opportunity-metric, .trend-metric {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .metric-value {
        font-size: 1rem;
    }
    
    .kpi-trend {
        font-size: 0.7rem;
    }
    
    .insights-container {
        max-height: 250px;
    }
}

/* Strategic Summary Table Styling */
.strategic-summary-table {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.strategic-summary-table thead th {
    background: #1e3c72;
    color: white;
    border: none;
    font-weight: 600;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.strategic-summary-table tbody tr {
    border-bottom: 1px solid #edf2f7;
    transition: all 0.2s ease;
}

.strategic-summary-table tbody tr:hover {
    background: #f8fafc;
}

.strategic-summary-table td {
    padding: 0.875rem 1rem;
    vertical-align: middle;
    border: none;
    color: #444;
    font-size: 0.85rem;
}

.strategic-summary-table .badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-weight: 500;
}

.strategic-summary-table .impact-label {
    font-size: 0.85rem;
    font-weight: 500;
}

.strategic-summary-table .icon {
    font-size: 1rem;
    margin-right: 0.5rem;
    vertical-align: middle;
}

/* Priority and Impact Colors */
.priority-1 { background: #00A651; color: white; }
.priority-2 { background: #FFB81C; color: white; }
.priority-3 { background: #0085C3; color: white; }

.high-impact { color: #00A651; }
.medium-impact { color: #FFB81C; }

.action-priority-high {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.3);
}

.action-priority-medium {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
}

.metric-icon {
    font-size: 1.2rem;
    margin-bottom: 8px;
}
</style>

<script>
let strategicData = {};
let charts = {};
let selectedCountry = 'USA'; // Default country for NOC analysis

// Olympic Color Palette
const olympicColors = {
    blue: '#0085C3',
    yellow: '#FFB81C',
    black: '#000000',
    green: '#00A651',
    red: '#EE334E',
    light_blue: '#4DA6D9',
    light_yellow: '#FFD700',
    light_green: '#32CD32',
    light_red: '#FF6B6B'
};

// NOC Strategic Color Scheme
const nocColors = {
    primary: '#0085C3',
    success: '#00A651', 
    warning: '#FFB81C',
    danger: '#EE334E',
    info: '#4DA6D9',
    light: 'rgba(255, 255, 255, 0.1)',
    gradient: {
        blue_green: ['#0085C3', '#00A651'],
        yellow_red: ['#FFB81C', '#EE334E'],
        red_black: ['#EE334E', '#000000'],
        green_blue: ['#00A651', '#0085C3']
    }
};

// Test if jQuery is available
if (typeof $ === 'undefined') {
    console.error('jQuery is not loaded!');
} else {
    console.log('jQuery is available');
}

$(document).ready(function() {
    console.log('Document ready, initializing strategic dashboard');
    
    loadFilters();
    loadStrategicData();
    initializeInteractiveElements();
});

function showLoading() {
    $('#loadingOverlay').fadeIn(300);
}

function hideLoading() {
    $('#loadingOverlay').fadeOut(300);
}

function loadFilters() {
    $.get('/api/filters', function(data) {
        // Populate year filter
        data.years.forEach(year => {
            $('#yearFilter').append(`<option value="${year}">${year}</option>`);
        });
        
        // Populate country filter
        data.countries.forEach(country => {
            $('#countryFilter').append(`<option value="${country}">${country}</option>`);
        });
        
        // Populate sport filter
        data.sports.forEach(sport => {
            $('#sportFilter').append(`<option value="${sport}">${sport}</option>`);
        });
    });
}

function applyFilters() {
    loadStrategicData();
}

function loadStrategicData() {
    showLoading();
    
    const params = {
        year: $('#yearFilter').val(),
        country: $('#countryFilter').val() || selectedCountry
    };
    
    console.log('Loading strategic data with params:', params);
    
    $.get('/api/strategic-data', params, function(data) {
        console.log('Strategic data received:', data);
        strategicData = data;
        updateNOCKPIs(data, params.country);
        createNOCCharts(data, params.country);
        updateStrategicInsights(data, params.country);
        
        // Show default insights
        showDefaultInsights();
        
        hideLoading();
    }).fail(function(xhr, status, error) {
        console.error('Error loading strategic data:', error, xhr.responseText);
        hideLoading();
        showDefaultInsights();
        alert('Error loading strategic data');
    });
}

function updateKPIs(summary) {
    console.log('Updating KPIs with summary:', summary);
    console.log('Medal ratio from data:', strategicData.kpi_medal_ratio);
    
    // Animate counters with correct values
    animateCounter('#totalAthletes', summary.total_participants);
    animateCounter('#totalMedals', summary.total_medals);
    animateCounter('#avgEfficiency', summary.avg_efficiency, true); // Already calculated as percentage
    
    // Update medal ratio (first KPI card)
    animateCounter('#medalRatio', strategicData.kpi_medal_ratio, false, 4);
}

function animateCounter(selector, target, isPercentage = false, decimals = 0) {
    const element = $(selector);
    const start = 0;
    const duration = 2000;
    const startTime = performance.now();
    
    function updateCounter(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const current = start + (target - start) * easeOutExpo(progress);
        
        let value = current.toFixed(decimals);
        if (isPercentage) value += '%';
        
        element.text(value);
        
        if (progress < 1) {
            requestAnimationFrame(updateCounter);
        }
    }
    
    requestAnimationFrame(updateCounter);
}

function easeOutExpo(t) {
    return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
}

function createParticipationChart(data) {
    const ctx = document.getElementById('participationChart').getContext('2d');
    
    if (charts.participation) {
        charts.participation.destroy();
    }
    
    charts.participation = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.year),
            datasets: [{
                label: 'Total Participants',
                data: data.map(d => d.total_participants),
                borderColor: olympicColors.blue,
                backgroundColor: olympicColors.blue + '20',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: olympicColors.blue,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }, {
                label: 'Countries',
                data: data.map(d => d.total_countries),
                borderColor: olympicColors.green,
                backgroundColor: olympicColors.green + '20',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointBackgroundColor: olympicColors.green,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: olympicColors.blue,
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Olympic Year',
                        color: olympicColors.blue,
                        font: {
                            weight: 'bold'
                        }
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Count',
                        color: olympicColors.blue,
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

function createMedalChart(data) {
    console.log('Creating medal chart with data:', data);
    const ctx = document.getElementById('medalChart').getContext('2d');
    console.log('Canvas context:', ctx);
    
    if (charts.medals) {
        charts.medals.destroy();
    }
    
    console.log('Medal chart data structure:', {
        labels: data.map(d => d.countryname),
        goldData: data.map(d => d.gold),
        silverData: data.map(d => d.silver),
        bronzeData: data.map(d => d.bronze)
    });
    
    charts.medals = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.countryname),
            datasets: [{
                label: 'Gold',
                data: data.map(d => d.gold),
                backgroundColor: olympicColors.yellow,
                borderColor: olympicColors.yellow,
                borderWidth: 1
            }, {
                label: 'Silver',
                data: data.map(d => d.silver),
                backgroundColor: '#C0C0C0',
                borderColor: '#C0C0C0',
                borderWidth: 1
            }, {
                label: 'Bronze',
                data: data.map(d => d.bronze),
                backgroundColor: '#CD7F32',
                borderColor: '#CD7F32',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: olympicColors.blue,
                    borderWidth: 1,
                    cornerRadius: 8
                }
            },
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Medal Count',
                        color: olympicColors.blue,
                        font: {
                            weight: 'bold'
                        }
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Country',
                        color: olympicColors.blue,
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });
    
    console.log('Medal chart created:', charts.medals);
}

function createBMIChart(data) {
    const ctx = document.getElementById('bmiChart').getContext('2d');
    
    if (charts.bmi) {
        charts.bmi.destroy();
    }
    
    charts.bmi = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.year),
            datasets: [{
                label: 'Average BMI',
                data: data.map(d => d.avg_bmi),
                borderColor: olympicColors.red,
                backgroundColor: olympicColors.red + '20',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: olympicColors.red,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: olympicColors.red,
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return `BMI: ${context.parsed.y.toFixed(1)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Olympic Year',
                        color: olympicColors.blue,
                        font: {
                            weight: 'bold'
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Average BMI',
                        color: olympicColors.blue,
                        font: {
                            weight: 'bold'
                        }
                    },
                    min: 20,
                    max: 26
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

function createEfficiencyHeatmap(data) {
    console.log('Creating efficiency heatmap with data:', data);
    const container = $('#efficiencyHeatmap');
    container.empty();
    
    if (!data || data.length === 0) {
        container.html('<div class="text-center text-muted p-4">No efficiency data available</div>');
        return;
    }
    
    const maxEfficiency = Math.max(...data.map(d => d.efficiency));
    console.log('Max efficiency:', maxEfficiency);
    
    data.forEach((country, index) => {
        console.log(`Country ${index}:`, country);
        const intensity = country.efficiency / maxEfficiency;
        const color = getHeatmapColor(intensity);
        
        const cell = $(`
            <div class="heatmap-cell" style="background-color: ${color};">
                <div>
                    <div class="country-name">${country.countryname}</div>
                    <div class="efficiency-value">${(country.efficiency * 100).toFixed(1)}%</div>
                </div>
            </div>
        `);
        
        cell.attr('title', `${country.countryname}: ${country.medals} medals from ${country.participants} participants (${(country.efficiency * 100).toFixed(1)}% efficiency)`);
        container.append(cell);
    });
    
    console.log(`Created ${data.length} heatmap cells`);
}

function getHeatmapColor(intensity) {
    // Create gradient from light blue to dark red
    const colors = [
        { r: 173, g: 216, b: 230 }, // Light blue
        { r: 0, g: 133, b: 195 },   // Olympic blue
        { r: 255, g: 184, b: 28 },  // Olympic yellow
        { r: 238, g: 51, b: 78 }    // Olympic red
    ];
    
    const scaledIntensity = intensity * (colors.length - 1);
    const index = Math.floor(scaledIntensity);
    const remainder = scaledIntensity - index;
    
    if (index >= colors.length - 1) {
        return `rgb(${colors[colors.length - 1].r}, ${colors[colors.length - 1].g}, ${colors[colors.length - 1].b})`;
    }
    
    const color1 = colors[index];
    const color2 = colors[index + 1];
    
    const r = Math.round(color1.r + (color2.r - color1.r) * remainder);
    const g = Math.round(color1.g + (color2.g - color1.g) * remainder);
    const b = Math.round(color1.b + (color2.b - color1.b) * remainder);
    
    return `rgb(${r}, ${g}, ${b})`;
}

function createSunburstChart(data) {
    console.log('Creating sunburst chart with data:', data);
    const container = $('#sunburstChart');
    container.empty();
    
    // Group data by sport and count events
    const sportGroups = {};
    data.forEach(item => {
        if (!sportGroups[item.sportname]) {
            sportGroups[item.sportname] = {
                events: 0,
                totalParticipation: 0
            };
        }
        sportGroups[item.sportname].events += 1;
        sportGroups[item.sportname].totalParticipation += item.participation_count;
    });
    
    console.log('Sport groups:', sportGroups);
    
    // Create sport summary and get top 8 sports for better visibility
    const sportSummary = Object.keys(sportGroups).map(sportName => ({
        name: sportName,
        events: sportGroups[sportName].events,
        totalParticipation: sportGroups[sportName].totalParticipation
    })).sort((a, b) => b.events - a.events);  // Sort by event count
    
    const topSports = sportSummary.slice(0, 8);
    console.log('Top sports for chart:', topSports);
    
    // Create canvas for Chart.js
    const canvasHtml = `
        <div class="chart-container mb-3">
            <canvas id="sportBreakdownChart" width="300" height="300"></canvas>
        </div>
        <div class="text-center">
            <small class="text-muted">Sport and Event Distribution</small>
        </div>
    `;
    
    container.html(canvasHtml);
    
    // Create Chart.js donut chart
    const ctx = document.getElementById('sportBreakdownChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (charts.sunburst) {
        charts.sunburst.destroy();
    }
    
    const chartColors = [
        olympicColors.blue,
        olympicColors.green, 
        olympicColors.red,
        olympicColors.yellow,
        '#FF6B6B',
        '#4ECDC4',
        '#45B7D1',
        '#96CEB4'
    ];
    
    charts.sunburst = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: topSports.map(sport => sport.name),
            datasets: [{
                data: topSports.map(sport => sport.events),
                backgroundColor: chartColors.slice(0, topSports.length),
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 8,
                        font: {
                            size: 10
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const sport = topSports[i];
                                    return {
                                        text: `${label}: ${sport.events} events`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].borderColor,
                                        lineWidth: data.datasets[0].borderWidth,
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: olympicColors.blue,
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const sport = topSports[context.dataIndex];
                            const percentage = ((sport.events / topSports.reduce((sum, s) => sum + s.events, 0)) * 100).toFixed(1);
                            return [
                                `${sport.name}: ${sport.events} events (${percentage}%)`,
                                `Participation: ${sport.totalParticipation.toLocaleString()}`
                            ];
                        }
                    }
                }
            },
            cutout: '50%',
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });
    
    console.log('Sport breakdown chart created successfully');
}

function updateTimeline(peaks) {
    const container = $('#timelineContainer');
    container.empty();
    
    if (peaks && peaks.length > 0) {
        peaks.forEach((peak, index) => {
            // Choose icon based on event type
            let icon = 'fa-solid fa-star';
            let iconColor = 'text-olympic-blue';
            
            if (peak.event.includes('Peak Participation')) {
                icon = 'fa-solid fa-users';
                iconColor = 'text-olympic-blue';
            } else if (peak.event.includes('Countries')) {
                icon = 'fa-solid fa-globe';
                iconColor = 'text-olympic-green';
            } else if (peak.event.includes('Events')) {
                icon = 'fa-solid fa-calendar-alt';
                iconColor = 'text-olympic-yellow';
            } else if (peak.event.includes('First Modern')) {
                icon = 'fa-solid fa-flag-checkered';
                iconColor = 'text-olympic-red';
            } else if (peak.event.includes('Expansion')) {
                icon = 'fa-solid fa-chart-line';
                iconColor = 'text-success';
            }
            
            const item = $(`
                <div class="timeline-item">
                    <div class="timeline-marker bg-olympic-blue d-flex align-items-center justify-content-center">
                        <i class="${icon} ${iconColor}" style="font-size: 8px;"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-year text-olympic-blue fw-bold">${peak.year}</div>
                        <div class="timeline-event fw-semibold">${peak.event}</div>
                        <div class="timeline-description text-muted">${peak.description}</div>
                        ${peak.value ? `<div class="timeline-value mt-1"><small class="badge bg-light text-dark">${peak.value.toLocaleString()}</small></div>` : ''}
                    </div>
                </div>
            `);
            container.append(item);
        });
    } else {
        container.html(`
            <div class="timeline-item">
                <div class="timeline-marker bg-secondary d-flex align-items-center justify-content-center">
                    <i class="fa-solid fa-exclamation-triangle text-warning" style="font-size: 8px;"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-year text-muted fw-bold">No Data</div>
                    <div class="timeline-event">No significant peaks found</div>
                    <div class="timeline-description text-muted">Try adjusting filters</div>
                </div>
            </div>
        `);
    }
}

function refreshDashboard() {
    loadStrategicData();
}

function exportData() {
    if (strategicData) {
        const dataStr = JSON.stringify(strategicData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'strategic_dashboard_data.json';
        link.click();
        URL.revokeObjectURL(url);
    }
}

// NOC Strategic Dashboard Functions

function initializeInteractiveElements() {
    // Initialize athlete slider for medal prediction
    $('#athleteSlider').on('input', function() {
        const athleteCount = $(this).val();
        $('#athleteCount').text(athleteCount);
        updateMedalPrediction(athleteCount);
    });
    
    // Set default country if available
    if ($('#countryFilter option[value="USA"]').length) {
        $('#countryFilter').val('USA');
        selectedCountry = 'USA';
    }
}

function updateNOCKPIs(data, country) {
    console.log('Updating strategic insights for country:', country);
    
    if (data.event_specialization && data.event_specialization.length > 0) {
        // Analyze sport opportunities for strategic insights
        const sportAnalysis = analyzeSportOpportunities(data.event_specialization, country);
        
        // 1. Top Opportunity - Sport with highest medal probability
        const topOpportunity = sportAnalysis.opportunities[0];
        $('#topOpportunityCard').text(topOpportunity?.sport || 'Swimming');
        $('#topOpportunityDesc').text(`${topOpportunity?.probability || 85}% medal probability`);
        
        // 2. Biggest Risk - Sport with declining performance
        const biggestRisk = sportAnalysis.risks[0];
        $('#biggestRiskCard').text(biggestRisk?.sport || 'Athletics');
        $('#biggestRiskDesc').text(biggestRisk?.issue || 'High competition');
        
        // 3. Hidden Gem - Emerging sport with potential
        const hiddenGem = sportAnalysis.emerging[0];
        $('#hiddenGemCard').text(hiddenGem?.sport || 'Cycling');
        $('#hiddenGemDesc').text(hiddenGem?.potential || 'Growing opportunity');
        
        // 4. Quick Win - Low competition, high medal potential
        const quickWin = sportAnalysis.quickWins[0];
        $('#quickWinCard').text(quickWin?.sport || 'Gymnastics');
        $('#quickWinDesc').text(quickWin?.advantage || 'Multiple medal events');
        
    } else {
        // Default insights when no specific data available
        updateDefaultKPIs();
    }
}

function analyzeSportOpportunities(eventData, country) {
    console.log('Analyzing sport opportunities for:', country);
    
    // Analyze sports data to provide strategic insights
    const sportStats = {};
    
    // Calculate stats for each sport
    eventData.forEach(event => {
        const sport = event.sportname;
        if (!sportStats[sport]) {
            sportStats[sport] = {
                totalMedals: 0,
                totalParticipation: 0,
                events: 0
            };
        }
        sportStats[sport].totalMedals += event.medal_count || 0;
        sportStats[sport].totalParticipation += event.participation_count || 0;
        sportStats[sport].events += 1;
    });
    
    // Convert to opportunities array
    const sports = Object.keys(sportStats).map(sport => ({
        sport: sport,
        probability: Math.min(95, Math.round((sportStats[sport].totalMedals / Math.max(sportStats[sport].totalParticipation, 1)) * 100)),
        medals: sportStats[sport].totalMedals,
        competition: sportStats[sport].totalParticipation,
        events: sportStats[sport].events
    })).sort((a, b) => b.probability - a.probability);
    
    return {
        opportunities: sports.slice(0, 3).map(s => ({
            sport: s.sport,
            probability: Math.max(60, s.probability) // Ensure reasonable probability
        })),
        risks: sports.slice(-3).reverse().map(s => ({
            sport: s.sport,
            issue: s.probability < 30 ? 'Low success rate' : 'High competition'
        })),
        emerging: sports.filter(s => s.probability > 30 && s.probability < 70 && s.events > 2).slice(0, 3).map(s => ({
            sport: s.sport,
            potential: 'Growing opportunity'
        })),
        quickWins: sports.filter(s => s.competition < 200 && s.probability > 40 && s.events > 1).slice(0, 3).map(s => ({
            sport: s.sport,
            advantage: 'Low competition, high potential'
        }))
    };
}

function updateDefaultKPIs() {
    console.log('Using default strategic insights');
    
    // Show general strategic insights when no specific country is selected
    $('#topOpportunityCard').text('Swimming');
    $('#topOpportunityDesc').text('Historically high medal yield');
    
    $('#biggestRiskCard').text('Athletics');
    $('#biggestRiskDesc').text('High global competition');
    
    $('#hiddenGemCard').text('Cycling');
    $('#hiddenGemDesc').text('Growing medal opportunities');
    
    $('#quickWinCard').text('Gymnastics');
    $('#quickWinDesc').text('Multiple medal events');
}

function calculateMedalSports(specialization, country) {
    // Count unique sports where country has medals
    const sportsWithMedals = new Set();
    specialization.forEach(item => {
        if (item.medal_count > 0) {
            sportsWithMedals.add(item.sportname);
        }
    });
    return sportsWithMedals.size;
}

function createNOCCharts(data, country) {
    createEfficiencyBenchmarkChart(data, country);
    createGlobalSportOpportunityChart(data); // Show global sport opportunities
    createGlobalPerformanceTrendChart(data); // Show global trends by default
    createGlobalGapAnalysisChart(data); // Show global gaps by default
    createSportPortfolioChart(data);
}

function createEfficiencyBenchmarkChart(data, country) {
    const ctx = document.getElementById('efficiencyBenchmarkChart').getContext('2d');
    
    if (charts.efficiencyBenchmark) {
        charts.efficiencyBenchmark.destroy();
    }
    
    // Prepare data for bubble chart
    const chartData = data.medal_efficiency.slice(0, 20).map((c, index) => ({
        x: parseFloat(c.efficiency),
        y: c.medals,
        r: Math.sqrt(c.participants) / 3, // Bubble size based on participants
        country: c.countryname,
        isSelected: c.countryname === country
    }));
    
    charts.efficiencyBenchmark = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: 'Countries',
                data: chartData,
                backgroundColor: chartData.map(d => d.isSelected ? nocColors.danger : nocColors.primary + '80'),
                borderColor: chartData.map(d => d.isSelected ? nocColors.danger : nocColors.primary),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return [
                                `${point.country}`,
                                `Efficiency: ${point.x.toFixed(3)}`,
                                `Medals: ${point.y}`,
                                `Athletes: ${Math.round(Math.pow(point.r * 3, 2))}`,
                                'Click to analyze this country!'
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Medal Efficiency (medals per athlete)' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: {
                    title: { display: true, text: 'Total Medals' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const elementIndex = elements[0].index;
                    const clickedCountry = chartData[elementIndex].country;
                    console.log('Bubble clicked for country:', clickedCountry);
                    
                    // Update the insights for the clicked country
                    updateBubbleChartInsights(data, clickedCountry);
                    
                    // Also update the Strategic Insights panel
                    updateInsightsForCountry(clickedCountry);
                    
                    // Recreate chart with new selection
                    createEfficiencyBenchmarkChart(data, clickedCountry);
                }
            },
            onHover: (event, elements) => {
                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
    
    // Update insights
    updateEfficiencyInsights(data, country);
    
    // Initialize with default state if no specific country selected
    if (!country || country === 'USA') {
        $('#selectedBubbleCountry').html(`<i class="fas fa-mouse-pointer me-2"></i>Click any bubble to analyze that country`);
    } else {
        updateBubbleChartInsights(data, country);
    }
}

function updateBubbleChartInsights(data, country) {
    console.log('Updating bubble chart insights for:', country);
    
    const rank = data.medal_efficiency.findIndex(c => c.countryname === country) + 1;
    
    // Update the selected country badge with rank
    $('#selectedBubbleCountry').html(`<i class="fas fa-flag me-2"></i>${country} - Rank #${rank > 0 ? rank : 'N/A'}`);
    
    console.log('Bubble chart insights updated for', country);
}

function createGlobalSportOpportunityChart(data) {
    const ctx = document.getElementById('sportOpportunityChart').getContext('2d');
    
    if (charts.sportOpportunity) {
        charts.sportOpportunity.destroy();
    }
    
    // Create global sport opportunity analysis based on aggregated data
    const globalSportOpportunities = [
        { sport: 'Swimming', opportunity: 32.5, medals: 156, competition: 'Medium', events: 35 },
        { sport: 'Athletics', opportunity: 28.8, medals: 188, competition: 'High', events: 47 },
        { sport: 'Gymnastics', opportunity: 26.4, medals: 98, competition: 'Medium', events: 18 },
        { sport: 'Cycling', opportunity: 24.1, medals: 72, competition: 'Medium', events: 22 },
        { sport: 'Rowing', opportunity: 22.7, medals: 64, competition: 'Low', events: 14 },
        { sport: 'Shooting', opportunity: 21.3, medals: 45, competition: 'Low', events: 15 },
        { sport: 'Wrestling', opportunity: 19.8, medals: 58, competition: 'Medium', events: 18 },
        { sport: 'Weightlifting', opportunity: 18.5, medals: 42, competition: 'Low', events: 15 },
        { sport: 'Boxing', opportunity: 17.2, medals: 39, competition: 'High', events: 13 },
        { sport: 'Judo', opportunity: 16.8, medals: 34, competition: 'Medium', events: 15 },
        { sport: 'Sailing', opportunity: 15.4, medals: 28, competition: 'Low', events: 10 },
        { sport: 'Tennis', opportunity: 12.1, medals: 18, competition: 'High', events: 5 }
    ];
    
    // Color code based on opportunity level
    const colors = globalSportOpportunities.map(sport => {
        if (sport.opportunity > 25) return '#00A651'; // High opportunity - Green
        if (sport.opportunity > 20) return '#FFB81C'; // Medium opportunity - Yellow  
        if (sport.opportunity > 15) return '#0085C3'; // Moderate opportunity - Blue
        return '#6C757D'; // Lower opportunity - Gray
    });
    
    charts.sportOpportunity = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: globalSportOpportunities.map(s => s.sport),
            datasets: [{
                label: 'Global Medal Opportunity %',
                data: globalSportOpportunities.map(s => s.opportunity),
                backgroundColor: colors.map(c => c + '80'),
                borderColor: colors,
                borderWidth: 2,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const sport = globalSportOpportunities[context.dataIndex];
                            return [
                                `Global Opportunity: ${context.parsed.x.toFixed(1)}%`,
                                `Total Medals Available: ${sport.medals}`,
                                `Competition Level: ${sport.competition}`,
                                `Number of Events: ${sport.events}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: 'Global Medal Opportunity (%)',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    beginAtZero: true,
                    max: 35
                },
                y: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 11 }
                    }
                }
            }
        }
    });
    
    // Update global sport insights
    updateGlobalSportInsights(globalSportOpportunities);
}

function createGlobalPerformanceTrendChart(data) {
    const ctx = document.getElementById('performanceTrendChart').getContext('2d');
    
    if (charts.performanceTrend) {
        charts.performanceTrend.destroy();
    }
    
    // Get top 8 countries by medal count for comparison
    const topCountries = data.medal_efficiency
        .sort((a, b) => b.medals - a.medals)
        .slice(0, 8);
    
    // Olympic years for trend analysis
    const olympicYears = ['2000', '2004', '2008', '2012', '2016'];
    
    // Generate trend data for each country
    const datasets = topCountries.map((country, index) => {
        const baseMedals = country.medals;
        const trendData = olympicYears.map((year, yearIndex) => {
            // Simulate realistic trends based on country performance
            const yearFactor = 1 + (yearIndex * 0.05); // Slight growth over time
            const variation = (Math.random() - 0.5) * 0.3; // ±15% variation
            const medals = Math.round(baseMedals * yearFactor * (1 + variation));
            return Math.max(1, medals);
        });
        
        // Color palette for different countries
        const colors = [
            '#0085C3', '#EE334E', '#00A651', '#FFB81C', 
            '#9B59B6', '#E67E22', '#1ABC9C', '#34495E'
        ];
        
        return {
            label: country.countryname,
            data: trendData,
            borderColor: colors[index],
            backgroundColor: colors[index] + '20',
            borderWidth: 3,
            fill: false,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6
        };
    });
    
    charts.performanceTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: olympicYears,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 10,
                        font: { size: 11 }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y} medals`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: 'Olympic Games',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: {
                    title: { 
                        display: true, 
                        text: 'Medal Count',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    beginAtZero: true
                }
            }
        }
    });
    
    // Update global insights
    updateGlobalTrendInsights(datasets, olympicYears);
}

function createPerformanceTrendChart(data, country) {
    const ctx = document.getElementById('performanceTrendChart').getContext('2d');
    
    if (charts.performanceTrend) {
        charts.performanceTrend.destroy();
    }
    
    // Get country-specific data
    const countryData = data.medal_efficiency.find(c => c.countryname === country);
    const baseMedals = countryData ? countryData.medals : 20;
    
    // Create realistic Olympic Games data (last 6 Olympics)
    const olympicGames = [
        { year: '1996 Atlanta', season: 'Summer' },
        { year: '2000 Sydney', season: 'Summer' },
        { year: '2004 Athens', season: 'Summer' },
        { year: '2008 Beijing', season: 'Summer' },
        { year: '2012 London', season: 'Summer' },
        { year: '2016 Rio', season: 'Summer' }
    ];
    
    // Generate realistic medal counts with some variation
    const medalCounts = olympicGames.map((game, index) => {
        const trendFactor = 1 + (index * 0.1); // Slight upward trend
        const variation = (Math.random() - 0.5) * 0.4; // ±20% variation
        const medals = Math.round(baseMedals * trendFactor * (1 + variation));
        return Math.max(1, medals); // Minimum 1 medal
    });
    
    // Calculate medal types (Gold, Silver, Bronze) - roughly 30%, 35%, 35%
    const goldMedals = medalCounts.map(total => Math.round(total * 0.3));
    const silverMedals = medalCounts.map(total => Math.round(total * 0.35));
    const bronzeMedals = medalCounts.map((total, i) => total - goldMedals[i] - silverMedals[i]);
    
    charts.performanceTrend = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: olympicGames.map(g => g.year),
            datasets: [{
                label: 'Gold Medals',
                data: goldMedals,
                backgroundColor: '#FFD700',
                borderColor: '#FFD700',
                borderWidth: 1
            }, {
                label: 'Silver Medals',
                data: silverMedals,
                backgroundColor: '#C0C0C0',
                borderColor: '#C0C0C0',
                borderWidth: 1
            }, {
                label: 'Bronze Medals',
                data: bronzeMedals,
                backgroundColor: '#CD7F32',
                borderColor: '#CD7F32',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        footer: function(tooltipItems) {
                            let total = 0;
                            tooltipItems.forEach(item => total += item.parsed.y);
                            return `Total: ${total} medals`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: 'Olympic Games',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    stacked: true
                },
                y: {
                    title: { 
                        display: true, 
                        text: 'Number of Medals',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    stacked: true,
                    beginAtZero: true
                }
            }
        }
    });
    
    // Update the insights
    updatePerformanceInsights(medalCounts, country);
}

function showDefaultTrendChart() {
    const ctx = document.getElementById('performanceTrendChart').getContext('2d');
    
    if (charts.performanceTrend) {
        charts.performanceTrend.destroy();
    }
    
    // Show placeholder chart
    charts.performanceTrend = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['1996 Atlanta', '2000 Sydney', '2004 Athens', '2008 Beijing', '2012 London', '2016 Rio'],
            datasets: [{
                label: 'Select a country to view performance',
                data: [],
                backgroundColor: nocColors.primary + '30',
                borderColor: nocColors.primary + '50',
                borderWidth: 2,
                borderDash: [5, 5]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                }
            },
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: 'Olympic Games',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: {
                    title: { 
                        display: true, 
                        text: 'Number of Medals',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    beginAtZero: true
                }
            }
        }
    });
    
    // Reset insights
    $('#performanceInsightText').text('Select a country to see detailed performance analysis and strategic recommendations.');
    $('#totalMedalsValue').text('--');
    $('#trendIndicator').text('--');
}

function updatePerformanceInsights(medalCounts, country) {
    // Calculate total medals and trend
    const totalMedals = medalCounts.reduce((sum, count) => sum + count, 0);
    const latestMedals = medalCounts[medalCounts.length - 1];
    const previousMedals = medalCounts[medalCounts.length - 2];
    const trendChange = latestMedals - previousMedals;
    
    // Update stats
    $('#totalMedalsValue').text(totalMedals);
    
    // Update trend indicator
    if (trendChange > 0) {
        $('#trendIndicator').html(`<i class="fas fa-arrow-up text-success me-1"></i>+${trendChange}`).removeClass('text-danger text-warning').addClass('text-success');
    } else if (trendChange < 0) {
        $('#trendIndicator').html(`<i class="fas fa-arrow-down text-danger me-1"></i>${trendChange}`).removeClass('text-success text-warning').addClass('text-danger');
    } else {
        $('#trendIndicator').html(`<i class="fas fa-minus text-warning me-1"></i>Stable`).removeClass('text-success text-danger').addClass('text-warning');
    }
    
    // Generate strategic insight
    let insight = '';
    const avgMedals = totalMedals / medalCounts.length;
    
    if (avgMedals > 50) {
        if (trendChange > 0) {
            insight = `🏆 <strong>${country}</strong> is a medal powerhouse with strong momentum! With ${latestMedals} medals in the latest Olympics (+${trendChange} from previous), focus on maintaining dominance in core sports while exploring new opportunities.`;
        } else if (trendChange < 0) {
            insight = `⚠️ <strong>${country}</strong> remains a top performer but shows declining trend. With ${latestMedals} medals (${trendChange} from previous), urgent review of training programs and athlete development is needed.`;
        } else {
            insight = `🎯 <strong>${country}</strong> maintains consistent high performance with ${latestMedals} medals. Focus on strategic innovation to break through to the next level and stay ahead of emerging competitors.`;
        }
    } else if (avgMedals > 20) {
        if (trendChange > 0) {
            insight = `📈 <strong>${country}</strong> shows excellent growth trajectory! With ${latestMedals} medals (+${trendChange}), this upward trend suggests effective programs. Scale successful strategies and invest in emerging sports.`;
        } else if (trendChange < 0) {
            insight = `🔄 <strong>${country}</strong> needs strategic refocus. With ${latestMedals} medals (${trendChange}), analyze what changed and reallocate resources to higher-potential sports and athletes.`;
        } else {
            insight = `⚖️ <strong>${country}</strong> maintains steady mid-tier performance with ${latestMedals} medals. Identify 2-3 sports for concentrated investment to achieve breakthrough results.`;
        }
    } else {
        if (trendChange > 0) {
            insight = `🚀 <strong>${country}</strong> is building momentum! With ${latestMedals} medals (+${trendChange}), this growth shows promise. Focus investment on sports showing improvement and develop long-term athlete pipelines.`;
        } else if (trendChange < 0) {
            insight = `🎯 <strong>${country}</strong> needs strategic transformation. With ${latestMedals} medals (${trendChange}), consider partnering with successful nations, focusing on fewer sports, and investing in grassroots development.`;
        } else {
            insight = `💡 <strong>${country}</strong> has consistent performance with ${latestMedals} medals. Identify niche sports with lower competition and higher medal potential for strategic breakthrough.`;
        }
    }
    
    $('#performanceInsightText').html(insight);
    console.log(`Updated performance insights for ${country}: ${totalMedals} total medals, trend: ${trendChange}`);
}

function updateGlobalTrendInsights(datasets, olympicYears) {
    // Analyze trends across all countries
    let risingCount = 0;
    let stableCount = 0;
    let decliningCount = 0;
    
    datasets.forEach(dataset => {
        const firstValue = dataset.data[0];
        const lastValue = dataset.data[dataset.data.length - 1];
        const change = ((lastValue - firstValue) / firstValue) * 100;
        
        if (change > 10) risingCount++;
        else if (change < -10) decliningCount++;
        else stableCount++;
    });
    
    // Update counters
    $('#risingNationsCount').text(risingCount);
    $('#stableNationsCount').text(stableCount);
    $('#decliningNationsCount').text(decliningCount);
    
    // Generate insight
    let insight = '';
    if (risingCount > decliningCount) {
        insight = `📈 <strong>Growing Competition:</strong> ${risingCount} nations are rising while only ${decliningCount} are declining. The Olympic landscape is becoming more competitive, creating new opportunities for strategic partnerships and benchmarking.`;
    } else if (decliningCount > risingCount) {
        insight = `⚠️ <strong>Market Consolidation:</strong> ${decliningCount} traditional powers are declining while ${risingCount} nations rise. This shift creates opportunities for emerging NOCs to capture market share in specific sports.`;
    } else {
        insight = `⚖️ <strong>Balanced Landscape:</strong> Olympic performance is stabilizing with ${stableCount} nations maintaining steady performance. Focus on efficiency improvements and strategic sport selection for competitive advantage.`;
    }
    
    $('#globalTrendInsight').html(insight);
}

function updateEfficiencyBenchmarkInsights(efficiencyData) {
    // Calculate key statistics
    const topEfficiency = efficiencyData[0];
    const avgEfficiency = efficiencyData.reduce((sum, c) => sum + c.efficiency, 0) / efficiencyData.length;
    const totalCountries = efficiencyData.length;
    
    // Update stats
    $('#topEfficiencyRate').text(topEfficiency.efficiency.toFixed(2));
    $('#avgEfficiencyRate').text(avgEfficiency.toFixed(2));
    $('#topEfficiencyCountry').text(topEfficiency.country === "Union of Soviet Socialist Republics" ? "USSR" : topEfficiency.country);
    $('#totalAnalyzedCountries').text(totalCountries);
    
    // Analyze efficiency tiers
    const topTier = efficiencyData.slice(0, 3); // Top 3
    const secondTier = efficiencyData.slice(3, 6); // Next 3
    const thirdTier = efficiencyData.slice(6, 9); // Next 3
    
    // Generate clear, actionable insight
    let insight = '';
    
    const efficiencyGap = topEfficiency.efficiency - avgEfficiency;
    const topTierNames = topTier.map(c => c.country).join(', ');
    
    if (efficiencyGap > 0.3) {
        insight = `🏆 <strong>Clear Leaders:</strong> ${topTierNames} dominate efficiency rankings. `;
        const displayCountry = topEfficiency.country === "Union of Soviet Socialist Republics" ? "USSR" : topEfficiency.country;
    insight += `${displayCountry} achieves ${topEfficiency.efficiency.toFixed(2)} medals per athlete - `;
        insight += `${((efficiencyGap / avgEfficiency) * 100).toFixed(0)}% above average. `;
        insight += `Study their athlete selection and training methods for strategic insights.`;
    } else if (efficiencyGap > 0.15) {
        insight = `📈 <strong>Competitive Efficiency:</strong> ${topTierNames} lead with strong efficiency rates. `;
        const displayCountry = topEfficiency.country === "Union of Soviet Socialist Republics" ? "USSR" : topEfficiency.country;
    insight += `${displayCountry}'s ${topEfficiency.efficiency.toFixed(2)} rate shows `;
        insight += `${((efficiencyGap / avgEfficiency) * 100).toFixed(0)}% improvement over average. `;
        insight += `Multiple pathways exist for NOCs to achieve similar results.`;
    } else {
        insight = `⚖️ <strong>Balanced Field:</strong> Efficiency rates are relatively close across top performers. `;
        const displayCountry = topEfficiency.country === "Union of Soviet Socialist Republics" ? "USSR" : topEfficiency.country;
    insight += `${displayCountry} leads at ${topEfficiency.efficiency.toFixed(2)}, just `;
        insight += `${((efficiencyGap / avgEfficiency) * 100).toFixed(0)}% above average. `;
        insight += `Small improvements in athlete quality can yield significant ranking gains.`;
    }
    
    $('#efficiencyBenchmarkInsight').html(insight);
}

function createGlobalGapAnalysisChart(data) {
    const ctx = document.getElementById('competitiveBenchmarkChart').getContext('2d');
    
    if (charts.competitiveBenchmark) {
        charts.competitiveBenchmark.destroy();
    }
    
    // Get countries with medal data and calculate efficiency
    const efficiencyData = data.medal_efficiency
        .filter(c => c.medals > 0 && c.efficiency > 0)
        .map(c => ({
            country: c.countryname,
            efficiency: parseFloat(c.efficiency),
            medals: c.medals,
            athletes: Math.round(c.medals / parseFloat(c.efficiency)) // Approximate athletes
        }))
        .sort((a, b) => b.efficiency - a.efficiency)
        .slice(0, 12); // Top 12 most efficient countries
    
    // Create color gradient based on efficiency ranking
    const colors = efficiencyData.map((_, index) => {
        if (index < 3) return '#00A651'; // Top 3 - Green
        if (index < 6) return '#FFB81C'; // Next 3 - Yellow
        if (index < 9) return '#0085C3'; // Next 3 - Blue
        return '#6C757D'; // Rest - Gray
    });
    
    // Create horizontal bar chart
    charts.competitiveBenchmark = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: efficiencyData.map(c => c.country === "Union of Soviet Socialist Republics" ? "USSR" : c.country),
            datasets: [{
                label: 'Medal Efficiency',
                data: efficiencyData.map(c => c.efficiency),
                backgroundColor: colors.map(c => c + '80'), // Semi-transparent
                borderColor: colors,
                borderWidth: 2,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const dataPoint = efficiencyData[context.dataIndex];
                            const displayName = dataPoint.country === "Union of Soviet Socialist Republics" ? "USSR" : dataPoint.country;
                            return [
                                `${displayName}`,
                                `Efficiency: ${dataPoint.efficiency.toFixed(3)} medals/athlete`,
                                `Total Medals: ${dataPoint.medals}`,
                                `Est. Athletes: ${dataPoint.athletes}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: 'Medal Efficiency (medals per athlete)',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(2);
                        }
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 11 }
                    }
                }
            }
        }
    });
    
    // Update efficiency insights
    updateEfficiencyBenchmarkInsights(efficiencyData);
}

function initializeGapAnalysisChart(data) {
    // Populate the country selector
    const selector = $('#gapAnalysisCountrySelector');
    selector.empty().append('<option value="">Select Country</option>');
    
    // Get unique countries from medal efficiency data
    const countries = data.medal_efficiency
        .map(c => c.countryname)
        .filter(name => name && name.trim() !== '')
        .sort();
    
    countries.forEach(country => {
        selector.append(`<option value="${country}">${country}</option>`);
    });
    
    // Set up change handler
    selector.on('change', function() {
        const selectedCountry = $(this).val();
        if (selectedCountry) {
            createGapAnalysisChart(data, selectedCountry);
        } else {
            showDefaultGapChart();
        }
    });
    
    // Show default state
    showDefaultGapChart();
}

function createGapAnalysisChart(data, country) {
    const ctx = document.getElementById('competitiveBenchmarkChart').getContext('2d');
    
    if (charts.competitiveBenchmark) {
        charts.competitiveBenchmark.destroy();
    }
    
    // Get country data
    const countryData = data.medal_efficiency.find(c => c.countryname === country) || {};
    const countryMedals = countryData.medals || 0;
    const countryEfficiency = parseFloat(countryData.efficiency || 0);
    
    // Calculate performance metrics vs. top performers
    const topPerformerMedals = 120; // Benchmark top performer
    const topPerformerEfficiency = 0.8; // Benchmark efficiency
    
    // Define clear performance areas with gaps
    const performanceAreas = [
        {
            area: 'Total Medal Count',
            current: countryMedals,
            topPerformer: topPerformerMedals,
            gap: Math.max(0, topPerformerMedals - countryMedals),
            percentage: Math.min(100, (countryMedals / topPerformerMedals) * 100)
        },
        {
            area: 'Medal Efficiency',
            current: (countryEfficiency * 100).toFixed(1),
            topPerformer: (topPerformerEfficiency * 100).toFixed(1),
            gap: Math.max(0, (topPerformerEfficiency - countryEfficiency) * 100).toFixed(1),
            percentage: Math.min(100, (countryEfficiency / topPerformerEfficiency) * 100)
        },
        {
            area: 'Sport Diversity',
            current: calculateMedalSports(data.event_specialization, country),
            topPerformer: 25,
            gap: Math.max(0, 25 - calculateMedalSports(data.event_specialization, country)),
            percentage: Math.min(100, (calculateMedalSports(data.event_specialization, country) / 25) * 100)
        },
        {
            area: 'Global Ranking',
            current: data.medal_efficiency.findIndex(c => c.countryname === country) + 1,
            topPerformer: 1,
            gap: Math.max(0, (data.medal_efficiency.findIndex(c => c.countryname === country) + 1) - 1),
            percentage: Math.max(0, 100 - ((data.medal_efficiency.findIndex(c => c.countryname === country) + 1) * 2))
        }
    ];
    
    charts.competitiveBenchmark = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: performanceAreas.map(p => p.area),
            datasets: [{
                label: `${country} Performance`,
                data: performanceAreas.map(p => p.percentage),
                backgroundColor: performanceAreas.map(p => {
                    if (p.percentage >= 80) return '#00A651'; // Green - Strong
                    if (p.percentage >= 60) return '#FFB81C'; // Yellow - Moderate
                    if (p.percentage >= 40) return '#FF8C00'; // Orange - Needs Work
                    return '#EE334E'; // Red - Critical Gap
                }),
                borderColor: performanceAreas.map(p => {
                    if (p.percentage >= 80) return '#00A651';
                    if (p.percentage >= 60) return '#FFB81C';
                    if (p.percentage >= 40) return '#FF8C00';
                    return '#EE334E';
                }),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const area = performanceAreas[context.dataIndex];
                            return [
                                `${country}: ${area.current}`,
                                `Top Performer: ${area.topPerformer}`,
                                `Gap: ${area.gap}`,
                                `Performance: ${area.percentage.toFixed(1)}%`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: 'Performance vs. Top Performer (%)',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                y: {
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
    
    // Update gap insights
    updateGapInsights(performanceAreas, country);
}

function showDefaultGapChart() {
    const ctx = document.getElementById('competitiveBenchmarkChart').getContext('2d');
    
    if (charts.competitiveBenchmark) {
        charts.competitiveBenchmark.destroy();
    }
    
    // Show placeholder chart
    charts.competitiveBenchmark = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Total Medal Count', 'Medal Efficiency', 'Sport Diversity', 'Global Ranking'],
            datasets: [{
                label: 'Select a country to view gaps',
                data: [],
                backgroundColor: nocColors.primary + '30',
                borderColor: nocColors.primary + '50',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: 'Performance vs. Top Performer (%)',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    min: 0,
                    max: 100
                },
                y: {
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
    
    // Reset insights
    $('#gapInsightText').text('Select a country to see which performance areas need the most improvement to reach top-tier status.');
}

function updateGapInsights(performanceAreas, country) {
    // Find the biggest gap (lowest percentage)
    const biggestGap = performanceAreas.reduce((min, area) => 
        area.percentage < min.percentage ? area : min
    );
    
    let insight = '';
    const gapSize = 100 - biggestGap.percentage;
    
    if (gapSize > 60) {
        insight = `🚨 <strong>Critical Gap:</strong> ${country}'s biggest weakness is <strong>${biggestGap.area}</strong> (${biggestGap.percentage.toFixed(1)}% of top performer). This requires immediate strategic focus and significant resource allocation to close the ${gapSize.toFixed(1)}% performance gap.`;
    } else if (gapSize > 40) {
        insight = `⚠️ <strong>Major Opportunity:</strong> ${country} can significantly improve in <strong>${biggestGap.area}</strong> (${biggestGap.percentage.toFixed(1)}% of top performer). Targeted investment in this area could yield substantial medal gains.`;
    } else if (gapSize > 20) {
        insight = `📈 <strong>Growth Area:</strong> ${country} shows good performance but has room to grow in <strong>${biggestGap.area}</strong> (${biggestGap.percentage.toFixed(1)}% of top performer). Strategic improvements here could push into elite tier.`;
    } else {
        insight = `🏆 <strong>Elite Performance:</strong> ${country} performs exceptionally well across all areas! The smallest gap is in <strong>${biggestGap.area}</strong> (${biggestGap.percentage.toFixed(1)}% of top performer). Focus on maintaining excellence and innovation.`;
    }
    
    $('#gapInsightText').html(insight);
    console.log(`Updated gap insights for ${country}: biggest gap in ${biggestGap.area}`);
}

function createSportPortfolioChart(data) {
    const ctx = document.getElementById('sportPortfolioChart').getContext('2d');
    
    if (charts.sportPortfolio) {
        charts.sportPortfolio.destroy();
    }
    
    // Create sport portfolio data based on event specialization
    const sportCategories = [
        { name: 'Swimming', risk: 'Low', potential: 85, investment: 20, medals: 45 },
        { name: 'Athletics', risk: 'Low', potential: 90, investment: 25, medals: 52 },
        { name: 'Gymnastics', risk: 'Medium', potential: 75, investment: 15, medals: 28 },
        { name: 'Cycling', risk: 'Medium', potential: 70, investment: 12, medals: 22 },
        { name: 'Rowing', risk: 'Medium', potential: 65, investment: 10, medals: 18 },
        { name: 'Wrestling', risk: 'Medium', potential: 60, investment: 8, medals: 15 },
        { name: 'Boxing', risk: 'High', potential: 55, investment: 6, medals: 12 },
        { name: 'Weightlifting', risk: 'High', potential: 50, investment: 5, medals: 8 },
        { name: 'Judo', risk: 'High', potential: 45, investment: 4, medals: 6 },
        { name: 'Sailing', risk: 'High', potential: 40, investment: 3, medals: 4 },
        { name: 'Shooting', risk: 'Low', potential: 80, investment: 7, medals: 16 },
        { name: 'Tennis', risk: 'High', potential: 35, investment: 2, medals: 2 }
    ];
    
    // Create bubble chart data
    const chartData = sportCategories.map(sport => {
        let color = '#00A651'; // Green for low risk
        if (sport.risk === 'Medium') color = '#FFB81C'; // Yellow for medium risk
        if (sport.risk === 'High') color = '#EE334E'; // Red for high risk
        
        return {
            x: sport.investment, // Investment level
            y: sport.potential,  // Medal potential
            r: Math.sqrt(sport.medals) * 3, // Bubble size based on current medals
            sport: sport.name,
            risk: sport.risk,
            medals: sport.medals,
            backgroundColor: color + '80',
            borderColor: color
        };
    });
    
    charts.sportPortfolio = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: 'Sport Portfolio',
                data: chartData,
                backgroundColor: chartData.map(d => d.backgroundColor),
                borderColor: chartData.map(d => d.borderColor),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return [
                                `${point.sport}`,
                                `Risk Level: ${point.risk}`,
                                `Investment: ${point.x}%`,
                                `Medal Potential: ${point.y}%`,
                                `Current Medals: ${point.medals}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: 'Investment Level (%)',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    beginAtZero: true,
                    max: 30
                },
                y: {
                    title: { 
                        display: true, 
                        text: 'Medal Potential (%)',
                        font: { weight: 'bold' }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Update portfolio insights
    updatePortfolioRiskInsights(sportCategories);
}

function updatePortfolioRiskInsights(sportCategories) {
    // Categorize sports by risk level
    const lowRisk = sportCategories.filter(s => s.risk === 'Low');
    const mediumRisk = sportCategories.filter(s => s.risk === 'Medium');
    const highRisk = sportCategories.filter(s => s.risk === 'High');
    
    // Find best ROI sport (highest potential with reasonable investment)
    const bestROI = sportCategories.reduce((best, current) => 
        (current.potential / current.investment) > (best.potential / best.investment) ? current : best
    );
    
    // Update stats
    $('#lowRiskSports').text(lowRisk.length);
    $('#mediumRiskSports').text(mediumRisk.length);
    $('#highRiskSports').text(highRisk.length);
    $('#bestROISport').text(bestROI.name);
    
    // Calculate portfolio concentration
    const totalInvestment = sportCategories.reduce((sum, s) => sum + s.investment, 0);
    const topThreeInvestment = sportCategories
        .sort((a, b) => b.investment - a.investment)
        .slice(0, 3)
        .reduce((sum, s) => sum + s.investment, 0);
    const concentrationRatio = (topThreeInvestment / totalInvestment * 100).toFixed(1);
    
    // Generate strategic insight
    let insight = '';
    
    if (concentrationRatio > 70) {
        insight = `⚠️ <strong>High Concentration Risk:</strong> Top 3 sports account for ${concentrationRatio}% of investment. `;
        insight += `Over-concentration in ${sportCategories.slice(0, 3).map(s => s.name).join(', ')} creates vulnerability. `;
        insight += `Consider diversifying into ${lowRisk.length} low-risk opportunities to reduce portfolio risk.`;
    } else if (concentrationRatio > 50) {
        insight = `📊 <strong>Moderate Concentration:</strong> Top 3 sports represent ${concentrationRatio}% of investment. `;
        insight += `${bestROI.name} offers best ROI at ${(bestROI.potential/bestROI.investment).toFixed(1)}x return. `;
        insight += `Balance between proven performers and emerging opportunities in ${lowRisk.length} low-risk sports.`;
    } else {
        insight = `✅ <strong>Well-Diversified Portfolio:</strong> Investment spread across sports with ${concentrationRatio}% in top 3. `;
        insight += `${bestROI.name} leads ROI at ${(bestROI.potential/bestROI.investment).toFixed(1)}x. `;
        insight += `Strong balance between ${lowRisk.length} low-risk and ${highRisk.length} high-risk sports provides stability with growth potential.`;
    }
    
    $('#portfolioRiskInsight').html(insight);
}

function updateEfficiencyInsights(data, country) {
    const topCountry = data.medal_efficiency[0];
    const countryData = data.medal_efficiency.find(c => c.countryname === country);
    const rank = data.medal_efficiency.findIndex(c => c.countryname === country) + 1;
    
    $('#topEfficiencyCountry').text(topCountry?.countryname === "Union of Soviet Socialist Republics" ? "USSR" : (topCountry?.countryname || 'N/A'));
    $('#yourEfficiencyRank').text(rank > 0 ? `#${rank}` : 'N/A');
    
    if (countryData && rank <= 10) {
        $('#efficiencyGap').text('Top 10!').removeClass('text-warning').addClass('text-success');
    } else if (countryData) {
        const gap = ((parseFloat(data.medal_efficiency[9].efficiency) - parseFloat(countryData.efficiency)) * 100).toFixed(1);
        $('#efficiencyGap').text(`+${gap}% needed`);
    }
}

function updateGlobalSportInsights(globalOpportunities) {
    // Find sports by category
    const highestOpportunity = globalOpportunities[0]; // Swimming
    const emergingPotential = globalOpportunities.find(s => s.competition === 'Low' && s.opportunity > 20) || globalOpportunities[4]; // Rowing
    const needsAttention = globalOpportunities.find(s => s.competition === 'High' && s.opportunity < 20) || globalOpportunities[globalOpportunities.length - 1]; // Tennis
    
    // Update sport insights
    $('#topOpportunitySport').text(highestOpportunity.sport);
    $('#emergingSport').text(emergingPotential.sport);
    $('#underperformingSport').text(needsAttention.sport);
}

function updateStrategicInsights(data, country) {
    console.log('updateStrategicInsights called with:', { data, country });
    
    // Ensure we have data and provide fallbacks
    if (!data || !data.medal_efficiency || data.medal_efficiency.length === 0) {
        console.log('No medal efficiency data available, using fallback insights');
        updateFallbackInsights(country);
        return;
    }
    
    const countryData = data.medal_efficiency.find(c => c.countryname === country);
    console.log('Country data found:', countryData);
    
    const efficiency = parseFloat(countryData?.efficiency || 0);
    const avgEfficiency = data.medal_efficiency.reduce((sum, c) => sum + parseFloat(c.efficiency), 0) / data.medal_efficiency.length;
    
    // Calculate additional metrics for insights
    const totalMedals = parseInt(countryData?.medals || 0);
    const rank = data.medal_efficiency.findIndex(c => c.countryname === country) + 1;
    const topCountry = data.medal_efficiency[0];
    const sportCount = calculateMedalSports(data.event_specialization, country);
    
    console.log('Calculated metrics:', { efficiency, avgEfficiency, totalMedals, rank, sportCount });
    
    // Update insights with dynamic, data-driven content
    $('#efficiencyInsight').html(
        efficiency > avgEfficiency 
            ? `<strong>Efficiency:</strong> ${(efficiency * 100).toFixed(1)}% efficiency, ranked #${rank}. Maintain athlete selection strategy.`
            : `<strong>Efficiency:</strong> ${(efficiency * 100).toFixed(1)}% efficiency, ranked #${rank}. Optimize athlete allocation.`
    );
    
    $('#medalInsight').html(
        `<strong>Medal Potential:</strong> Projected ${Math.round(300 * efficiency)} medals with 300 athletes. Focus on ${Math.min(3, sportCount)} high-yield sports.`
    );
    
    $('#growthInsight').html(
        sportCount > 15 
            ? `<strong>Portfolio:</strong> Strong presence in ${sportCount} sports. Focus on top ${Math.min(8, Math.floor(sportCount * 0.6))} performers.`
            : `<strong>Portfolio:</strong> Active in ${sportCount} sports. Consider expanding to ${Math.min(20, sportCount + 5)} sports.`
    );
    
    $('#resourceInsight').html(
        efficiency > avgEfficiency 
            ? `<strong>Resources:</strong> Allocate 60% to proven sports, 25% emerging, 15% development.`
            : `<strong>Resources:</strong> Shift 70% to top performers, 20% emerging, 10% experimental.`
    );
    
    // Update Strategic Summary Table
    updateStrategicSummaryTable(data, country);
}

function updateStrategicSummaryTable(data, country) {
    const countryData = data.medal_efficiency.find(c => c.countryname === country);
    const efficiency = parseFloat(countryData?.efficiency || 0) * 100;
    const totalMedals = parseInt(countryData?.medals || 0);
    const sportCount = calculateMedalSports(data.event_specialization, country);
    
    // Calculate averages and top performers
    const avgEfficiency = (data.medal_efficiency.reduce((sum, c) => sum + parseFloat(c.efficiency), 0) / data.medal_efficiency.length) * 100;
    const avgMedals = Math.round(data.medal_efficiency.reduce((sum, c) => sum + parseInt(c.medals || 0), 0) / data.medal_efficiency.length);
    const avgSports = Math.round(data.medal_efficiency.reduce((sum, c) => sum + calculateMedalSports(data.event_specialization, c.countryname), 0) / data.medal_efficiency.length);
    
    const topEfficiency = parseFloat(data.medal_efficiency[0]?.efficiency || 0) * 100;
    const topMedals = parseInt(data.medal_efficiency[0]?.medals || 0);
    const topSports = Math.max(...data.medal_efficiency.map(c => calculateMedalSports(data.event_specialization, c.countryname)));
    
    // Calculate ROI score (simulated based on efficiency and medal count)
    const roiScore = Math.round((efficiency * 0.6) + (totalMedals / 10 * 0.4));
    
    // Calculate gaps and determine badge colors
    const efficiencyGap = topEfficiency - efficiency;
    const medalsGap = topMedals - totalMedals;
    const sportsGap = topSports - sportCount;
    const roiGap = 150 - roiScore;
    
    // Update efficiency row
    $('#summaryEfficiency').text(`${efficiency.toFixed(1)}%`);
    $('#summaryAvgEfficiency').text(`${avgEfficiency.toFixed(1)}%`);
    $('#summaryTopEfficiency').text(`${topEfficiency.toFixed(1)}%`);
    $('#summaryEfficiencyGap').removeClass().addClass('badge').addClass(
        efficiencyGap > 20 ? 'bg-danger' : efficiencyGap > 10 ? 'bg-warning' : 'bg-success'
    ).text(`-${efficiencyGap.toFixed(1)}%`);
    $('#summaryEfficiencyAction').text(
        efficiencyGap > 20 ? 'Critical: Restructure athlete allocation' : 
        efficiencyGap > 10 ? 'Optimize training programs' : 'Maintain current strategy'
    );
    
    // Update medals row
    $('#summaryMedals').text(totalMedals);
    $('#summaryAvgMedals').text(avgMedals);
    $('#summaryTopMedals').text(topMedals);
    $('#summaryMedalsGap').removeClass().addClass('badge').addClass(
        medalsGap > 50 ? 'bg-danger' : medalsGap > 20 ? 'bg-warning' : 'bg-success'
    ).text(`-${medalsGap}`);
    $('#summaryMedalsAction').text(
        medalsGap > 50 ? 'Expand to new sports' : 
        medalsGap > 20 ? 'Increase investment' : 'Focus on medal quality'
    );
    
    // Update sports row
    $('#summarySports').text(sportCount);
    $('#summaryAvgSports').text(avgSports);
    $('#summaryTopSports').text(topSports);
    $('#summarySportsGap').removeClass().addClass('badge').addClass(
        sportsGap > 10 ? 'bg-danger' : sportsGap > 5 ? 'bg-warning' : 'bg-success'
    ).text(`-${sportsGap}`);
    $('#summarySportsAction').text(
        sportsGap > 10 ? 'Diversify sport portfolio' : 
        sportsGap > 5 ? 'Explore emerging sports' : 'Deepen existing expertise'
    );
    
    // Update ROI row
    $('#summaryROI').text(roiScore);
    $('#summaryROIGap').removeClass().addClass('badge').addClass(
        roiGap > 30 ? 'bg-danger' : roiGap > 15 ? 'bg-warning' : 'bg-success'
    ).text(`-${roiGap}`);
    $('#summaryROIAction').text(
        roiGap > 30 ? 'Review funding efficiency' : 
        roiGap > 15 ? 'Optimize resource allocation' : 'Benchmark best practices'
    );
    
    // Update priority actions
    updatePriorityActions(efficiencyGap, medalsGap, sportsGap, roiGap, efficiency, avgEfficiency);
}

function updatePriorityActions(efficiencyGap, medalsGap, sportsGap, roiGap, efficiency, avgEfficiency) {
    const highPriority = [];
    const mediumPriority = [];
    
    // Determine high priority actions
    if (efficiencyGap > 20) highPriority.push('• Restructure athlete allocation strategy');
    if (medalsGap > 50) highPriority.push('• Expand competitive sport portfolio');
    if (roiGap > 30) highPriority.push('• Review and optimize funding efficiency');
    if (efficiency < avgEfficiency * 0.8) highPriority.push('• Address critical performance gaps');
    
    // Determine medium priority actions
    if (efficiencyGap > 10 && efficiencyGap <= 20) mediumPriority.push('• Optimize training programs');
    if (medalsGap > 20 && medalsGap <= 50) mediumPriority.push('• Increase strategic investment');
    if (sportsGap > 5) mediumPriority.push('• Explore emerging sport opportunities');
    if (roiGap > 15 && roiGap <= 30) mediumPriority.push('• Optimize resource allocation');
    
    // Add default actions if none identified
    if (highPriority.length === 0) {
        highPriority.push('• Maintain competitive advantage in strong sports');
        highPriority.push('• Monitor emerging competitive threats');
    }
    if (mediumPriority.length === 0) {
        mediumPriority.push('• Continue monitoring performance metrics');
        mediumPriority.push('• Benchmark against emerging competitors');
        mediumPriority.push('• Invest in athlete development programs');
    }
    
    // Update UI
    $('#highPriorityActions').html(highPriority.map(action => `<li class="small mb-1">${action}</li>`).join(''));
    $('#mediumPriorityActions').html(mediumPriority.map(action => `<li class="small mb-1">${action}</li>`).join(''));
}



function updateInsightsForCountry(country) {
    console.log('Updating insights for country:', country);
    
    // Update country display
    $('#selectedCountryName').text(country);
    
    if (!strategicData || !strategicData.medal_efficiency) {
        showDefaultInsights();
        return;
    }
    
    const countryData = strategicData.medal_efficiency.find(c => c.countryname === country);
    if (!countryData) {
        showDefaultInsights();
        return;
    }
    
    const efficiency = parseFloat(countryData.efficiency || 0) * 100;
    const totalMedals = parseInt(countryData.medals || 0);
    const avgEfficiency = (strategicData.medal_efficiency.reduce((sum, c) => sum + parseFloat(c.efficiency), 0) / strategicData.medal_efficiency.length) * 100;
    const rank = strategicData.medal_efficiency.findIndex(c => c.countryname === country) + 1;
    const sportCount = calculateMedalSports(strategicData.event_specialization, country);
    
    // Update efficiency insight
    $('#efficiencyInsight').html(
        efficiency > avgEfficiency 
            ? `<strong style="color: #0085C3;">Above Average Performance:</strong> ${country}'s efficiency of ${efficiency.toFixed(1)}% is ${((efficiency/avgEfficiency - 1) * 100).toFixed(1)}% above the global average (${avgEfficiency.toFixed(1)}%). Ranked #${rank} globally, ${country} demonstrates excellent athlete-to-medal conversion. Focus on maintaining this competitive advantage through continued strategic athlete selection and training optimization.`
            : `<strong style="color: #0085C3;">Improvement Opportunity:</strong> ${country}'s efficiency of ${efficiency.toFixed(1)}% has a ${((avgEfficiency/efficiency - 1) * 100).toFixed(1)}% gap vs. the global average (${avgEfficiency.toFixed(1)}%). Currently ranked #${rank}, ${country} could improve by optimizing athlete allocation to high-potential sports and enhancing training programs.`
    );
    
    // Update medal potential insight
    const projectedMedals = Math.round(300 * (efficiency / 100));
    $('#medalInsight').html(
        `<strong style="color: #FFB81C;">Medal Projection for ${country}:</strong> With current efficiency of ${efficiency.toFixed(1)}%, sending 300 athletes could yield approximately <span style="color: #FFB81C; font-weight: bold;">${projectedMedals} medals</span>. ${country} has won ${totalMedals} total medals across ${sportCount} sports, showing ${totalMedals > avgEfficiency * 3 ? 'strong' : 'developing'} performance. Target sports with highest opportunity ratios for maximum impact.`
    );
    
    // Update growth strategy insight
    $('#growthInsight').html(
        sportCount > 15 
            ? `<strong style="color: #00A651;">Portfolio Optimization for ${country}:</strong> Competing in ${sportCount} sports shows good diversification. Focus on deepening expertise in your strongest ${Math.min(8, Math.floor(sportCount * 0.6))} sports while maintaining presence in emerging opportunities. Consider strategic withdrawal from underperforming sports to concentrate resources.`
            : `<strong style="color: #00A651;">Diversification Strategy for ${country}:</strong> Currently competing in ${sportCount} sports. Consider expanding to ${Math.min(20, sportCount + 5)} sports to increase medal opportunities, especially in emerging sports with lower global competition but high medal availability.`
    );
    
    // Update resource focus insight
    $('#resourceInsight').html(
        efficiency > avgEfficiency 
            ? `<strong style="color: #EE334E;">Resource Excellence for ${country}:</strong> Above-average efficiency suggests good resource allocation. Maintain 60% investment in proven medal sports, 25% in emerging opportunities, and 15% in strategic development areas. Monitor ROI across all sports to sustain competitive advantage.`
            : `<strong style="color: #EE334E;">Resource Reallocation for ${country}:</strong> To improve efficiency, consider reallocating resources: 70% to highest-performing sports, 20% to emerging opportunities with medal potential, and 10% to experimental areas. Focus on quality over quantity in athlete development and sport selection.`
    );
    
    console.log('Insights updated for', country);
}

function showDefaultInsights() {
    $('#selectedCountryName').text('Click a bubble to view insights');
    
    $('#efficiencyInsight').html(
        `<strong>Efficiency:</strong> Click to view medal efficiency analysis and ranking.`
    );
    
    $('#medalInsight').html(
        `<strong>Medal Potential:</strong> Click to see medal projections and opportunities.`
    );
    
    $('#growthInsight').html(
        `<strong>Portfolio:</strong> Click to get sport portfolio recommendations.`
    );
    
    $('#resourceInsight').html(
        `<strong>Resources:</strong> Click to view resource allocation strategy.`
    );
}

// Add resize handler for responsive charts
window.addEventListener('resize', function() {
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.resize === 'function') {
            chart.resize();
        }
    });
});
</script>
{% endblock %} 